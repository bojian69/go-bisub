<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.title}}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/admin">BI订阅管理</a>
            <div class="navbar-nav">
                <a class="nav-link active" href="/admin/subscriptions">订阅管理</a>
                <a class="nav-link" href="/admin/stats">统计报表</a>
                <a class="nav-link" href="/admin/operation-logs">操作日志</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>订阅管理</h2>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createModal">
                创建订阅
            </button>
        </div>

        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="subscriptionsTable">
                        <thead>
                            <tr>
                                <th>订阅Key</th>
                                <th>版本</th>
                                <th>标题</th>
                                <th>状态</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- 数据通过JavaScript加载 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 创建订阅模态框 -->
    <div class="modal fade" id="createModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">创建订阅</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createForm">
                        <div class="mb-3">
                            <label class="form-label">订阅Key</label>
                            <input type="text" class="form-control" name="subscription_key" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">版本号</label>
                            <input type="number" class="form-control" name="version" min="1" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">标题</label>
                            <input type="text" class="form-control" name="title" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">描述</label>
                            <textarea class="form-control" name="description" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">SQL内容</label>
                            <textarea class="form-control" name="sql_content" rows="5" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">SQL变量 (JSON格式)</label>
                            <textarea class="form-control" name="sql_variables" rows="3" placeholder='{"variable_replace": "变量描述"}'></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">状态</label>
                            <select class="form-select" name="status" required>
                                <option value="A">待生效</option>
                                <option value="B" selected>生效中</option>
                                <option value="C">强制兼容</option>
                                <option value="D">已失效</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="createSubscription()">创建</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = '/v1';
        const AUTH_TOKEN = 'Bearer your-jwt-token'; // 实际应该从登录获取

        // 加载订阅列表
        async function loadSubscriptions() {
            try {
                const response = await fetch(`${API_BASE}/subscriptions`, {
                    headers: {
                        'Authorization': AUTH_TOKEN,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                if (result.code === 'OK') {
                    renderSubscriptions(result.data.items);
                } else {
                    console.error('API Error:', result.message);
                    showError('获取订阅列表失败: ' + result.message);
                }
            } catch (error) {
                console.error('Load subscriptions error:', error);
                showError('获取订阅列表失败: ' + error.message);
            }
        }

        // 渲染订阅列表
        function renderSubscriptions(subscriptions) {
            const tbody = document.querySelector('#subscriptionsTable tbody');
            tbody.innerHTML = '';
            
            subscriptions.forEach(sub => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${sub.sub_key}</td>
                    <td>${sub.version}</td>
                    <td>${sub.title}</td>
                    <td><span class="badge ${getStatusBadgeClass(sub.status)}">${getStatusText(sub.status)}</span></td>
                    <td>${formatDateTime(sub.created_at)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editSubscription('${sub.sub_key}', ${sub.version})">
                            编辑
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="executeSubscription('${sub.sub_key}', ${sub.version})">
                            执行
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteSubscription('${sub.sub_key}', ${sub.version})">
                            删除
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // 创建订阅
        async function createSubscription() {
            const form = document.getElementById('createForm');
            const formData = new FormData(form);
            
            // 构建请求数据
            const data = {
                type: 'A',
                sub_key: formData.get('subscription_key'),
                version: parseInt(formData.get('version')),
                title: formData.get('title'),
                abstract: formData.get('description') || '',
                status: formData.get('status'),
                extra_config: {
                    sql_content: formData.get('sql_content'),
                    sql_replace: {},
                    example: '{}'
                }
            };
            
            // 处理SQL变量
            if (formData.get('sql_variables')) {
                try {
                    data.extra_config.sql_replace = JSON.parse(formData.get('sql_variables'));
                } catch (e) {
                    showError('SQL变量格式错误，请输入有效的JSON');
                    return;
                }
            }
            
            try {
                const response = await fetch(`${API_BASE}/subscriptions`, {
                    method: 'POST',
                    headers: {
                        'Authorization': AUTH_TOKEN,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (result.code === 'OK') {
                    showSuccess('订阅创建成功！');
                    bootstrap.Modal.getInstance(document.getElementById('createModal')).hide();
                    form.reset();
                    loadSubscriptions();
                } else {
                    showError('创建失败: ' + result.message);
                }
            } catch (error) {
                console.error('Create subscription error:', error);
                showError('创建失败: ' + error.message);
            }
        }

        // 执行订阅
        async function executeSubscription(subKey, version) {
            const variables = prompt('请输入执行参数 (JSON格式):', '{}');
            if (variables === null) return;
            
            try {
                const params = JSON.parse(variables);
                const response = await fetch(`${API_BASE}/subscriptions/${subKey}/versions/${version}/execute`, {
                    method: 'POST',
                    headers: {
                        'Authorization': AUTH_TOKEN,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        variables: params,
                        timeout: 30000
                    })
                });
                
                const result = await response.json();
                if (result.code === 'OK') {
                    showSuccess('执行成功！');
                    console.log('执行结果:', result.data);
                } else {
                    showError('执行失败: ' + result.message);
                }
            } catch (error) {
                console.error('Execute subscription error:', error);
                showError('执行失败: ' + error.message);
            }
        }

        // 删除订阅
        async function deleteSubscription(subKey, version) {
            if (!confirm(`确定要删除订阅 ${subKey} 版本 ${version} 吗？`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/subscriptions/${subKey}/versions/${version}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': AUTH_TOKEN,
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                if (result.code === 'OK') {
                    showSuccess('删除成功！');
                    loadSubscriptions();
                } else {
                    showError('删除失败: ' + result.message);
                }
            } catch (error) {
                console.error('Delete subscription error:', error);
                showError('删除失败: ' + error.message);
            }
        }

        // 编辑订阅（简化实现）
        function editSubscription(subKey, version) {
            alert(`编辑功能开发中... 订阅: ${subKey}, 版本: ${version}`);
        }

        // 工具函数
        function getStatusText(status) {
            const statusMap = {
                'A': '待生效',
                'B': '生效中',
                'C': '强制兼容',
                'D': '已失效'
            };
            return statusMap[status] || status;
        }

        function getStatusBadgeClass(status) {
            const classMap = {
                'A': 'bg-warning',
                'B': 'bg-success',
                'C': 'bg-info',
                'D': 'bg-secondary'
            };
            return classMap[status] || 'bg-secondary';
        }

        function formatDateTime(dateStr) {
            return new Date(dateStr).toLocaleString('zh-CN');
        }

        function showSuccess(message) {
            alert('✅ ' + message);
        }

        function showError(message) {
            alert('❌ ' + message);
        }

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadSubscriptions();
        });
    </script>
</body>
</html>