<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.title}}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-badge {
            font-size: 0.85em;
        }

        .action-buttons .btn {
            margin-right: 5px;
        }

        .code-editor {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/admin">BIè®¢é˜…ç®¡ç†</a>
            <div class="navbar-nav">
                <a class="nav-link active" href="/admin/subscriptions">è®¢é˜…ç®¡ç†</a>
                <a class="nav-link" href="/admin/stats">ç»Ÿè®¡æŠ¥è¡¨</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>è®¢é˜…ç®¡ç†</h2>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createModal">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-lg"
                    viewBox="0 0 16 16">
                    <path
                        d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2Z" />
                </svg>
                åˆ›å»ºè®¢é˜…
            </button>
        </div>

        <!-- æœç´¢å’Œç­›é€‰ -->
        <div class="card mb-3">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <input type="text" class="form-control" id="searchKey" placeholder="æœç´¢è®¢é˜…Key">
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" id="filterStatus">
                            <option value="">å…¨éƒ¨çŠ¶æ€</option>
                            <option value="A">å¾…ç”Ÿæ•ˆ</option>
                            <option value="B">ç”Ÿæ•ˆä¸­</option>
                            <option value="C">å¼ºåˆ¶å…¼å®¹</option>
                            <option value="D">å·²å¤±æ•ˆ</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary" onclick="loadSubscriptions()">æœç´¢</button>
                        <button class="btn btn-secondary" onclick="resetFilters()">é‡ç½®</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- è®¢é˜…åˆ—è¡¨ -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>è®¢é˜…Key</th>
                                <th>ç‰ˆæœ¬</th>
                                <th>æ ‡é¢˜</th>
                                <th>ç±»å‹</th>
                                <th>çŠ¶æ€</th>
                                <th>åˆ›å»ºäºº</th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                                <th style="width: 200px;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="subscriptionsTable">
                            <tr>
                                <td colspan="8" class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">åŠ è½½ä¸­...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- åˆ†é¡µ -->
                <nav>
                    <ul class="pagination justify-content-center" id="pagination"></ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- åˆ›å»ºè®¢é˜…æ¨¡æ€æ¡† -->
    <div class="modal fade" id="createModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">åˆ›å»ºè®¢é˜…</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">è®¢é˜…Key <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="sub_key" required>
                                    <div class="form-text">å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œå»ºè®®ä½¿ç”¨ä¸‹åˆ’çº¿å‘½å</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">ç‰ˆæœ¬å· <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" name="version" min="1" value="1" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">ç±»å‹ <span class="text-danger">*</span></label>
                                    <select class="form-select" name="type" required>
                                        <option value="A" selected>åˆ†ææ•°æ®</option>
                                        <option value="B">ä¸šåŠ¡æ•°æ®</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">æ ‡é¢˜ <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="title" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">æè¿°</label>
                            <textarea class="form-control" name="abstract" rows="2"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">SQLå†…å®¹ <span class="text-danger">*</span></label>
                            <textarea class="form-control code-editor" name="sql_content" rows="8" required
                                placeholder="SELECT * FROM table WHERE id = {{id}}"></textarea>
                            <div class="form-text">ä½¿ç”¨ {{variable_name}} ä½œä¸ºå˜é‡å ä½ç¬¦</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">SQLå˜é‡è¯´æ˜ (JSONæ ¼å¼)</label>
                            <textarea class="form-control code-editor" name="sql_replace" rows="4"
                                placeholder='{"id": "ç”¨æˆ·ID", "date": "æŸ¥è¯¢æ—¥æœŸ"}'></textarea>
                            <div class="form-text">å®šä¹‰SQLä¸­ä½¿ç”¨çš„å˜é‡åŠå…¶è¯´æ˜</div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">æ•°æ®æº</label>
                                    <input type="text" class="form-control" name="db_source" placeholder="default">
                                    <div class="form-text">ç•™ç©ºä½¿ç”¨é»˜è®¤æ•°æ®æº</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">çŠ¶æ€ <span class="text-danger">*</span></label>
                                    <select class="form-select" name="status" required>
                                        <option value="A">å¾…ç”Ÿæ•ˆ</option>
                                        <option value="B" selected>ç”Ÿæ•ˆä¸­</option>
                                        <option value="C">å¼ºåˆ¶å…¼å®¹ä½ç‰ˆæœ¬</option>
                                        <option value="D">å·²å¤±æ•ˆ</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="createSubscription()">åˆ›å»º</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ‰§è¡Œè®¢é˜…æ¨¡æ€æ¡† -->
    <div class="modal fade" id="executeModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">æ‰§è¡Œè®¢é˜…</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">è®¢é˜…ä¿¡æ¯</label>
                        <div id="executeInfo" class="alert alert-info"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">æ‰§è¡Œå‚æ•° (JSONæ ¼å¼)</label>
                        <textarea class="form-control code-editor" id="executeVariables" rows="6"
                            placeholder='{"id": 123, "date": "2024-01-01"}'>{}</textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">è¶…æ—¶æ—¶é—´ (æ¯«ç§’)</label>
                        <input type="number" class="form-control" id="executeTimeout" value="30000">
                    </div>
                    <div id="executeResult" class="mt-3" style="display:none;">
                        <label class="form-label">æ‰§è¡Œç»“æœ</label>
                        <pre class="bg-light p-3 rounded" id="executeResultContent"></pre>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                    <button type="button" class="btn btn-primary" onclick="doExecute()">æ‰§è¡Œ</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = '/v1';
        let currentPage = 1;
        let currentLimit = 20;
        let executeContext = {};

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function () {
            loadSubscriptions();
        });

        // åŠ è½½è®¢é˜…åˆ—è¡¨
        async function loadSubscriptions(page = 1) {
            currentPage = page;
            const offset = (page - 1) * currentLimit;

            try {
                const response = await fetch(`${API_BASE}/subscriptions?limit=${currentLimit}&offset=${offset}`);
                const result = await response.json();

                if (result.code === 'OK') {
                    renderSubscriptions(result.data.items || []);
                    renderPagination(result.data.pagination);
                } else {
                    showError('è·å–è®¢é˜…åˆ—è¡¨å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('Load subscriptions error:', error);
                showError('è·å–è®¢é˜…åˆ—è¡¨å¤±è´¥: ' + error.message);
            }
        }

        // æ¸²æŸ“è®¢é˜…åˆ—è¡¨
        function renderSubscriptions(subscriptions) {
            const tbody = document.getElementById('subscriptionsTable');

            if (subscriptions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">æš‚æ— æ•°æ®</td></tr>';
                return;
            }

            tbody.innerHTML = subscriptions.map(sub => `
                <tr>
                    <td><code>${sub.sub_key}</code></td>
                    <td><span class="badge bg-secondary">v${sub.version}</span></td>
                    <td>${sub.title || '-'}</td>
                    <td>${getTypeText(sub.type)}</td>
                    <td><span class="badge ${getStatusBadgeClass(sub.status)}">${getStatusText(sub.status)}</span></td>
                    <td>${sub.creator_id || '-'}</td>
                    <td>${formatDateTime(sub.created_at)}</td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-outline-success" onclick='showExecuteModal(${JSON.stringify(sub)})' title="æ‰§è¡Œ">
                            â–¶
                        </button>
                        <button class="btn btn-sm btn-outline-primary" onclick='viewDetails(${JSON.stringify(sub)})' title="æŸ¥çœ‹">
                            ğŸ‘
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteSubscription('${sub.sub_key}', ${sub.version}, '${sub.type}')" title="åˆ é™¤">
                            ğŸ—‘
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // æ¸²æŸ“åˆ†é¡µ
        function renderPagination(pagination) {
            if (!pagination) return;

            const paginationEl = document.getElementById('pagination');
            const { current_page, total_pages } = pagination;

            let html = '';

            // ä¸Šä¸€é¡µ
            if (current_page > 1) {
                html += `<li class="page-item"><a class="page-link" href="#" onclick="loadSubscriptions(${current_page - 1}); return false;">ä¸Šä¸€é¡µ</a></li>`;
            }

            // é¡µç 
            for (let i = 1; i <= total_pages; i++) {
                if (i === 1 || i === total_pages || (i >= current_page - 2 && i <= current_page + 2)) {
                    const active = i === current_page ? 'active' : '';
                    html += `<li class="page-item ${active}"><a class="page-link" href="#" onclick="loadSubscriptions(${i}); return false;">${i}</a></li>`;
                } else if (i === current_page - 3 || i === current_page + 3) {
                    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }

            // ä¸‹ä¸€é¡µ
            if (current_page < total_pages) {
                html += `<li class="page-item"><a class="page-link" href="#" onclick="loadSubscriptions(${current_page + 1}); return false;">ä¸‹ä¸€é¡µ</a></li>`;
            }

            paginationEl.innerHTML = html;
        }

        // åˆ›å»ºè®¢é˜…
        async function createSubscription() {
            const form = document.getElementById('createForm');
            const formData = new FormData(form);

            // æ„å»ºè¯·æ±‚æ•°æ®
            const data = {
                type: formData.get('type'),
                sub_key: formData.get('sub_key'),
                version: parseInt(formData.get('version')),
                title: formData.get('title'),
                abstract: formData.get('abstract') || '',
                status: formData.get('status'),
                extra_config: {
                    sql_content: formData.get('sql_content'),
                    sql_replace: {},
                    db_source: formData.get('db_source') || 'default',
                    example: '{}'
                }
            };

            // å¤„ç†SQLå˜é‡
            if (formData.get('sql_replace')) {
                try {
                    data.extra_config.sql_replace = JSON.parse(formData.get('sql_replace'));
                } catch (e) {
                    showError('SQLå˜é‡æ ¼å¼é”™è¯¯ï¼Œè¯·è¾“å…¥æœ‰æ•ˆçš„JSON');
                    return;
                }
            }

            try {
                const response = await fetch(`${API_BASE}/subscriptions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (result.code === 'OK') {
                    showSuccess('è®¢é˜…åˆ›å»ºæˆåŠŸï¼');
                    bootstrap.Modal.getInstance(document.getElementById('createModal')).hide();
                    form.reset();
                    loadSubscriptions(currentPage);
                } else {
                    showError('åˆ›å»ºå¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('Create subscription error:', error);
                showError('åˆ›å»ºå¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤ºæ‰§è¡Œæ¨¡æ€æ¡†
        function showExecuteModal(sub) {
            executeContext = sub;
            document.getElementById('executeInfo').innerHTML = `
                <strong>è®¢é˜…Key:</strong> ${sub.sub_key}<br>
                <strong>ç‰ˆæœ¬:</strong> v${sub.version}<br>
                <strong>æ ‡é¢˜:</strong> ${sub.title}
            `;
            document.getElementById('executeVariables').value = '{}';
            document.getElementById('executeResult').style.display = 'none';
            new bootstrap.Modal(document.getElementById('executeModal')).show();
        }

        // æ‰§è¡Œè®¢é˜…
        async function doExecute() {
            const variables = document.getElementById('executeVariables').value;
            const timeout = parseInt(document.getElementById('executeTimeout').value);

            let params;
            try {
                params = JSON.parse(variables);
            } catch (e) {
                showError('å‚æ•°æ ¼å¼é”™è¯¯ï¼Œè¯·è¾“å…¥æœ‰æ•ˆçš„JSON');
                return;
            }

            try {
                const url = `${API_BASE}/subscriptions/${executeContext.sub_key}/versions/${executeContext.version}/execute?type=${executeContext.type}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ variables: params, timeout: timeout })
                });

                const result = await response.json();
                const resultEl = document.getElementById('executeResult');
                const contentEl = document.getElementById('executeResultContent');

                resultEl.style.display = 'block';
                if (result.code === 'OK') {
                    contentEl.textContent = JSON.stringify(result.data, null, 2);
                    contentEl.className = 'bg-light p-3 rounded';
                } else {
                    contentEl.textContent = `é”™è¯¯: ${result.message}`;
                    contentEl.className = 'bg-danger text-white p-3 rounded';
                }
            } catch (error) {
                console.error('Execute subscription error:', error);
                showError('æ‰§è¡Œå¤±è´¥: ' + error.message);
            }
        }

        // æŸ¥çœ‹è¯¦æƒ…
        function viewDetails(sub) {
            alert(`è®¢é˜…è¯¦æƒ…:\n\nKey: ${sub.sub_key}\nç‰ˆæœ¬: ${sub.version}\næ ‡é¢˜: ${sub.title}\næè¿°: ${sub.abstract || 'æ— '}\nçŠ¶æ€: ${getStatusText(sub.status)}`);
        }

        // åˆ é™¤è®¢é˜…
        async function deleteSubscription(subKey, version, type) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤è®¢é˜… ${subKey} ç‰ˆæœ¬ ${version} å—ï¼Ÿ`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/subscriptions/${subKey}/versions/${version}?type=${type}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                if (result.code === 'OK') {
                    showSuccess('åˆ é™¤æˆåŠŸï¼');
                    loadSubscriptions(currentPage);
                } else {
                    showError('åˆ é™¤å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('Delete subscription error:', error);
                showError('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // é‡ç½®ç­›é€‰
        function resetFilters() {
            document.getElementById('searchKey').value = '';
            document.getElementById('filterStatus').value = '';
            loadSubscriptions(1);
        }

        // å·¥å…·å‡½æ•°
        function getTypeText(type) {
            return type === 'A' ? 'åˆ†ææ•°æ®' : 'ä¸šåŠ¡æ•°æ®';
        }

        function getStatusText(status) {
            const map = { 'A': 'å¾…ç”Ÿæ•ˆ', 'B': 'ç”Ÿæ•ˆä¸­', 'C': 'å¼ºåˆ¶å…¼å®¹', 'D': 'å·²å¤±æ•ˆ' };
            return map[status] || status;
        }

        function getStatusBadgeClass(status) {
            const map = { 'A': 'bg-warning', 'B': 'bg-success', 'C': 'bg-info', 'D': 'bg-secondary' };
            return map[status] || 'bg-secondary';
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleString('zh-CN');
        }

        function showSuccess(message) {
            alert('âœ… ' + message);
        }

        function showError(message) {
            alert('âŒ ' + message);
        }
    </script>
</body>

</html>