<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.title}}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-badge {
            font-size: 0.85em;
        }

        .action-buttons .btn {
            margin-right: 5px;
        }

        .code-editor {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/admin">BIè®¢é˜…ç®¡ç†</a>
            <div class="navbar-nav">
                <a class="nav-link active" href="/admin/subscriptions">è®¢é˜…ç®¡ç†</a>
                <a class="nav-link" href="/admin/stats">ç»Ÿè®¡æŠ¥è¡¨</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>è®¢é˜…ç®¡ç†</h2>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createModal">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-lg"
                    viewBox="0 0 16 16">
                    <path
                        d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2Z" />
                </svg>
                åˆ›å»ºè®¢é˜…
            </button>
        </div>

        <!-- æœç´¢å’Œç­›é€‰ -->
        <div class="card mb-3">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <input type="text" class="form-control" id="searchKey" placeholder="æœç´¢è®¢é˜…Key">
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" id="filterStatus">
                            <option value="">å…¨éƒ¨çŠ¶æ€</option>
                            <option value="A">å¾…ç”Ÿæ•ˆ</option>
                            <option value="B">ç”Ÿæ•ˆä¸­</option>
                            <option value="C">ç”Ÿæ•ˆä¸­-å¼ºåˆ¶å…¼å®¹ä½ç‰ˆæœ¬</option>
                            <option value="D">å·²å¤±æ•ˆ</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary" onclick="loadSubscriptions()">æœç´¢</button>
                        <button class="btn btn-secondary" onclick="resetFilters()">é‡ç½®</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- è®¢é˜…åˆ—è¡¨ -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>è®¢é˜…Key</th>
                                <th>ç‰ˆæœ¬</th>
                                <th>æ ‡é¢˜</th>
                                <th>ç±»å‹</th>
                                <th>çŠ¶æ€</th>
                                <th>åˆ›å»ºäºº</th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                                <th style="width: 200px;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="subscriptionsTable">
                            <tr>
                                <td colspan="8" class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">åŠ è½½ä¸­...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- åˆ†é¡µ -->
                <nav>
                    <ul class="pagination justify-content-center" id="pagination"></ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- åˆ›å»ºè®¢é˜…æ¨¡æ€æ¡† -->
    <div class="modal fade" id="createModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">åˆ›å»ºè®¢é˜…</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">è®¢é˜…Key <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="sub_key" required>
                                    <div class="form-text">å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œå»ºè®®ä½¿ç”¨ä¸‹åˆ’çº¿å‘½å</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">ç‰ˆæœ¬å· <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" name="version" min="1" value="1" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">ç±»å‹ <span class="text-danger">*</span></label>
                                    <select class="form-select" name="type" required>
                                        <option value="A" selected>åˆ†ææ•°æ®</option>
                                        <option value="B">è¥é”€æ¨é€</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">æ ‡é¢˜ <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="title" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">æè¿°</label>
                            <textarea class="form-control" name="abstract" rows="2"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">SQLå†…å®¹ <span class="text-danger">*</span></label>
                            <textarea class="form-control code-editor" name="sql_content" rows="10" required
                                placeholder="SELECT house_id, count(distinct device_id) as number&#10;FROM uhomes_stat.stat_demand_log_events&#10;where ts_time between 'start_at_replace' and 'end_at_replace'&#10;and house_id in (house_id_replace)&#10;group by house_id"></textarea>
                            <div class="form-text text-danger fw-bold">
                                âš ï¸ é‡è¦ï¼šä½¿ç”¨ <code>xxx_replace</code> æ ¼å¼ä½œä¸ºå˜é‡å ä½ç¬¦ï¼ˆå¦‚ï¼šstart_at_replace, house_id_replaceï¼‰
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label mb-0">SQLå˜é‡è¯´æ˜</label>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-primary" onclick="extractVariablesFromSQL()">
                                        ğŸ” æå–å˜é‡
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" onclick="addVariable()">
                                        + æ·»åŠ å˜é‡
                                    </button>
                                </div>
                            </div>
                            <div class="alert alert-info mb-2 py-2">
                                <small>ä» SQL å†…å®¹ä¸­æå– <code>xxx_replace</code> æ ¼å¼çš„å˜é‡ï¼Œä¸ºæ¯ä¸ªå˜é‡æ·»åŠ è¯´æ˜</small>
                            </div>
                            <div id="variablesList" class="mb-2">
                                <div class="text-muted small">æš‚æ— å˜é‡ï¼Œç‚¹å‡»"æå–å˜é‡"æˆ–"æ·»åŠ å˜é‡"</div>
                            </div>
                            <input type="hidden" name="sql_replace" id="sql_replace_hidden">
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">æ•°æ®æº</label>
                                    <input type="text" class="form-control" name="db_source" placeholder="default">
                                    <div class="form-text">ç•™ç©ºä½¿ç”¨é»˜è®¤æ•°æ®æº</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">çŠ¶æ€</label>
                                    <input type="text" class="form-control" value="å¾…ç”Ÿæ•ˆ" disabled>
                                    <div class="form-text text-muted">æ–°åˆ›å»ºçš„è®¢é˜…é»˜è®¤ä¸º"å¾…ç”Ÿæ•ˆ"çŠ¶æ€</div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="createSubscription()">åˆ›å»º</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ‰§è¡Œè®¢é˜…æ¨¡æ€æ¡† -->
    <div class="modal fade" id="executeModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">æ‰§è¡Œè®¢é˜…</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">è®¢é˜…ä¿¡æ¯</label>
                        <div id="executeInfo" class="alert alert-info"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">æ‰§è¡Œå‚æ•° (JSONæ ¼å¼)</label>
                        <textarea class="form-control code-editor" id="executeVariables" rows="6"
                            placeholder='{"id": 123, "date": "2024-01-01"}'>{}</textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">è¶…æ—¶æ—¶é—´ (æ¯«ç§’)</label>
                        <input type="number" class="form-control" id="executeTimeout" value="30000">
                    </div>
                    <div id="executeResult" class="mt-3" style="display:none;">
                        <label class="form-label">æ‰§è¡Œç»“æœ</label>
                        <pre class="bg-light p-3 rounded" id="executeResultContent"></pre>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                    <button type="button" class="btn btn-primary" onclick="doExecute()">æ‰§è¡Œ</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = '/api';
        let currentPage = 1;
        let currentLimit = 20;
        let executeContext = {};

        // å˜é‡ç®¡ç†
        let variables = [];

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function () {
            loadSubscriptions();

            // ç›‘å¬ SQL å†…å®¹å˜åŒ–ï¼Œè‡ªåŠ¨æå–å˜é‡
            const sqlContent = document.querySelector('textarea[name="sql_content"]');
            if (sqlContent) {
                sqlContent.addEventListener('blur', extractVariablesFromSQL);
            }
        });

        // ä» SQL ä¸­æå–å˜é‡
        function extractVariablesFromSQL() {
            const sqlContent = document.querySelector('textarea[name="sql_content"]').value;

            if (!sqlContent.trim()) {
                showError('è¯·å…ˆè¾“å…¥ SQL å†…å®¹');
                return;
            }

            const regex = /(\w+_replace)/g;
            const matches = sqlContent.match(regex);

            if (matches) {
                const uniqueVars = [...new Set(matches)];
                let newCount = 0;

                // åªæ·»åŠ æ–°å˜é‡
                uniqueVars.forEach(varName => {
                    if (!variables.find(v => v.name === varName)) {
                        variables.push({ name: varName, description: '' });
                        newCount++;
                    }
                });

                renderVariables();

                if (newCount > 0) {
                    showSuccess(`æˆåŠŸæå– ${newCount} ä¸ªæ–°å˜é‡ï¼Œè¯·ä¸ºæ¯ä¸ªå˜é‡æ·»åŠ è¯´æ˜`);
                } else {
                    showSuccess('æ‰€æœ‰å˜é‡å·²å­˜åœ¨');
                }
            } else {
                showError('æœªæ‰¾åˆ° xxx_replace æ ¼å¼çš„å˜é‡');
            }
        }

        // æ·»åŠ å˜é‡
        function addVariable() {
            const varName = prompt('è¯·è¾“å…¥å˜é‡åï¼ˆæ ¼å¼ï¼šxxx_replaceï¼‰ï¼š');
            if (varName) {
                if (!varName.endsWith('_replace')) {
                    showError('å˜é‡åå¿…é¡»ä»¥ _replace ç»“å°¾');
                    return;
                }
                if (variables.find(v => v.name === varName)) {
                    showError('å˜é‡å·²å­˜åœ¨');
                    return;
                }
                variables.push({ name: varName, description: '' });
                renderVariables();
            }
        }

        // åˆ é™¤å˜é‡
        function removeVariable(index) {
            variables.splice(index, 1);
            renderVariables();
        }

        // æ¸²æŸ“å˜é‡åˆ—è¡¨
        function renderVariables() {
            const container = document.getElementById('variablesList');
            if (variables.length === 0) {
                container.innerHTML = '<div class="text-muted small">æš‚æ— å˜é‡ï¼Œç‚¹å‡»"æå–å˜é‡"æˆ–"æ·»åŠ å˜é‡"</div>';
                return;
            }

            container.innerHTML = variables.map((v, index) => `
                <div class="input-group mb-2">
                    <span class="input-group-text bg-light" style="min-width: 150px;">
                        <code class="text-primary">${v.name}</code>
                    </span>
                    <input type="text" 
                           class="form-control ${!v.description || !v.description.trim() ? 'border-danger' : ''}" 
                           placeholder="å˜é‡è¯´æ˜ï¼ˆå¿…å¡«ï¼Œå¦‚ï¼šå¼€å§‹æ—¶é—´ï¼‰" 
                           value="${v.description || ''}" 
                           required
                           onchange="variables[${index}].description = this.value; renderVariables()">
                    <button class="btn btn-outline-danger" type="button" onclick="removeVariable(${index})" title="åˆ é™¤å˜é‡">
                        âœ•
                    </button>
                </div>
            `).join('');

            // æ˜¾ç¤ºéªŒè¯æç¤º
            const emptyVars = variables.filter(v => !v.description || !v.description.trim());
            if (emptyVars.length > 0) {
                container.innerHTML += `
                    <div class="alert alert-warning mt-2 py-2" role="alert">
                        <small>âš ï¸ è¿˜æœ‰ ${emptyVars.length} ä¸ªå˜é‡æœªå¡«å†™è¯´æ˜</small>
                    </div>
                `;
            }
        }

        // åŠ è½½è®¢é˜…åˆ—è¡¨
        async function loadSubscriptions(page = 1) {
            currentPage = page;
            const offset = (page - 1) * currentLimit;

            try {
                const response = await fetch(`${API_BASE}/subscriptions?limit=${currentLimit}&offset=${offset}`);
                const result = await response.json();

                if (result.code === 'OK') {
                    renderSubscriptions(result.data.items || []);
                    renderPagination(result.data.pagination);
                } else {
                    showError('è·å–è®¢é˜…åˆ—è¡¨å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('Load subscriptions error:', error);
                showError('è·å–è®¢é˜…åˆ—è¡¨å¤±è´¥: ' + error.message);
            }
        }

        // æ¸²æŸ“è®¢é˜…åˆ—è¡¨
        function renderSubscriptions(subscriptions) {
            const tbody = document.getElementById('subscriptionsTable');

            if (subscriptions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">æš‚æ— æ•°æ®</td></tr>';
                return;
            }

            tbody.innerHTML = subscriptions.map(sub => `
                <tr>
                    <td><code>${sub.sub_key}</code></td>
                    <td><span class="badge bg-secondary">v${sub.version}</span></td>
                    <td>${sub.title || '-'}</td>
                    <td>${getTypeText(sub.type)}</td>
                    <td><span class="badge ${getStatusBadgeClass(sub.status)}">${getStatusText(sub.status)}</span></td>
                    <td>${sub.creator_id || '-'}</td>
                    <td>${formatDateTime(sub.created_at)}</td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-outline-success" onclick='showExecuteModal(${JSON.stringify(sub)})' title="æ‰§è¡Œ">
                            â–¶
                        </button>
                        <button class="btn btn-sm btn-outline-primary" onclick='viewDetails(${JSON.stringify(sub)})' title="æŸ¥çœ‹">
                            ğŸ‘
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteSubscription('${sub.sub_key}', ${sub.version}, '${sub.type}')" title="åˆ é™¤">
                            ğŸ—‘
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // æ¸²æŸ“åˆ†é¡µ
        function renderPagination(pagination) {
            if (!pagination) return;

            const paginationEl = document.getElementById('pagination');
            const { current_page, total_pages } = pagination;

            let html = '';

            // ä¸Šä¸€é¡µ
            if (current_page > 1) {
                html += `<li class="page-item"><a class="page-link" href="#" onclick="loadSubscriptions(${current_page - 1}); return false;">ä¸Šä¸€é¡µ</a></li>`;
            }

            // é¡µç 
            for (let i = 1; i <= total_pages; i++) {
                if (i === 1 || i === total_pages || (i >= current_page - 2 && i <= current_page + 2)) {
                    const active = i === current_page ? 'active' : '';
                    html += `<li class="page-item ${active}"><a class="page-link" href="#" onclick="loadSubscriptions(${i}); return false;">${i}</a></li>`;
                } else if (i === current_page - 3 || i === current_page + 3) {
                    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }

            // ä¸‹ä¸€é¡µ
            if (current_page < total_pages) {
                html += `<li class="page-item"><a class="page-link" href="#" onclick="loadSubscriptions(${current_page + 1}); return false;">ä¸‹ä¸€é¡µ</a></li>`;
            }

            paginationEl.innerHTML = html;
        }

        // åˆ›å»ºè®¢é˜…
        async function createSubscription() {
            const form = document.getElementById('createForm');
            const formData = new FormData(form);

            // ä» SQL ä¸­æå–æ‰€æœ‰å˜é‡
            const sqlContent = formData.get('sql_content');
            const regex = /(\w+_replace)/g;
            const sqlMatches = sqlContent.match(regex);
            const sqlVariables = sqlMatches ? [...new Set(sqlMatches)] : [];

            // æ„å»º SQL å˜é‡å¯¹è±¡ï¼ˆåªåŒ…å«æœ‰è¯´æ˜çš„å˜é‡ï¼‰
            const sqlReplace = {};
            const variablesWithDesc = [];

            variables.forEach(v => {
                if (v.name && v.description && v.description.trim()) {
                    sqlReplace[v.name] = v.description.trim();
                    variablesWithDesc.push(v.name);
                }
            });

            // ä¸¥æ ¼æ ¡éªŒï¼šSQL ä¸­çš„å˜é‡å¿…é¡»éƒ½æœ‰è¯´æ˜
            if (sqlVariables.length > 0) {
                // æ£€æŸ¥æ˜¯å¦æœ‰å˜é‡æ²¡æœ‰è¯´æ˜
                const missingDesc = variables.filter(v => v.name && (!v.description || !v.description.trim()));
                if (missingDesc.length > 0) {
                    showError(`ä»¥ä¸‹å˜é‡ç¼ºå°‘è¯´æ˜ï¼š${missingDesc.map(v => v.name).join(', ')}`);
                    return;
                }

                // æ£€æŸ¥ SQL ä¸­çš„å˜é‡æ˜¯å¦éƒ½åœ¨å˜é‡åˆ—è¡¨ä¸­
                const missingVars = sqlVariables.filter(v => !variablesWithDesc.includes(v));
                if (missingVars.length > 0) {
                    showError(`SQL ä¸­çš„ä»¥ä¸‹å˜é‡æœªæ·»åŠ è¯´æ˜ï¼š${missingVars.join(', ')}\nè¯·ç‚¹å‡»"æå–å˜é‡"æŒ‰é’®`);
                    return;
                }

                // æ£€æŸ¥å˜é‡åˆ—è¡¨ä¸­æ˜¯å¦æœ‰å¤šä½™çš„å˜é‡ï¼ˆä¸åœ¨ SQL ä¸­ï¼‰
                const extraVars = variablesWithDesc.filter(v => !sqlVariables.includes(v));
                if (extraVars.length > 0) {
                    if (!confirm(`å˜é‡åˆ—è¡¨ä¸­æœ‰ä¸åœ¨ SQL ä¸­çš„å˜é‡ï¼š${extraVars.join(', ')}\næ˜¯å¦ç»§ç»­æäº¤ï¼Ÿ`)) {
                        return;
                    }
                }

                // æœ€ç»ˆéªŒè¯ï¼šç¡®ä¿è‡³å°‘æœ‰ä¸€ä¸ªå˜é‡æœ‰è¯´æ˜
                if (Object.keys(sqlReplace).length === 0) {
                    showError('è¯·ä¸º SQL ä¸­çš„å˜é‡æ·»åŠ è¯´æ˜');
                    return;
                }
            }

            // æ„å»ºè¯·æ±‚æ•°æ®
            const data = {
                type: formData.get('type'),
                sub_key: formData.get('sub_key'),
                version: parseInt(formData.get('version')),
                title: formData.get('title'),
                abstract: formData.get('abstract') || '',
                status: 'A', // å›ºå®šä¸ºå¾…ç”Ÿæ•ˆçŠ¶æ€
                extra_config: {
                    sql_content: formData.get('sql_content'),
                    sql_replace: sqlReplace,
                    db_source: formData.get('db_source') || 'default',
                    example: JSON.stringify(sqlReplace)
                }
            };

            try {
                const response = await fetch(`${API_BASE}/subscriptions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (result.code === 'OK') {
                    showSuccess('è®¢é˜…åˆ›å»ºæˆåŠŸï¼');
                    bootstrap.Modal.getInstance(document.getElementById('createModal')).hide();
                    form.reset();
                    variables = []; // æ¸…ç©ºå˜é‡åˆ—è¡¨
                    renderVariables();
                    loadSubscriptions(currentPage);
                } else {
                    showError('åˆ›å»ºå¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('Create subscription error:', error);
                showError('åˆ›å»ºå¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤ºæ‰§è¡Œæ¨¡æ€æ¡†
        function showExecuteModal(sub) {
            executeContext = sub;
            document.getElementById('executeInfo').innerHTML = `
                <strong>è®¢é˜…Key:</strong> ${sub.sub_key}<br>
                <strong>ç‰ˆæœ¬:</strong> v${sub.version}<br>
                <strong>æ ‡é¢˜:</strong> ${sub.title}
            `;
            document.getElementById('executeVariables').value = '{}';
            document.getElementById('executeResult').style.display = 'none';
            new bootstrap.Modal(document.getElementById('executeModal')).show();
        }

        // æ‰§è¡Œè®¢é˜…
        async function doExecute() {
            const variables = document.getElementById('executeVariables').value;
            const timeout = parseInt(document.getElementById('executeTimeout').value);

            let params;
            try {
                params = JSON.parse(variables);
            } catch (e) {
                showError('å‚æ•°æ ¼å¼é”™è¯¯ï¼Œè¯·è¾“å…¥æœ‰æ•ˆçš„JSON');
                return;
            }

            try {
                const url = `${API_BASE}/subscriptions/${executeContext.sub_key}/versions/${executeContext.version}/execute?type=${executeContext.type}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ variables: params, timeout: timeout })
                });

                const result = await response.json();
                const resultEl = document.getElementById('executeResult');
                const contentEl = document.getElementById('executeResultContent');

                resultEl.style.display = 'block';
                if (result.code === 'OK') {
                    contentEl.textContent = JSON.stringify(result.data, null, 2);
                    contentEl.className = 'bg-light p-3 rounded';
                } else {
                    contentEl.textContent = `é”™è¯¯: ${result.message}`;
                    contentEl.className = 'bg-danger text-white p-3 rounded';
                }
            } catch (error) {
                console.error('Execute subscription error:', error);
                showError('æ‰§è¡Œå¤±è´¥: ' + error.message);
            }
        }

        // æŸ¥çœ‹è¯¦æƒ…
        function viewDetails(sub) {
            alert(`è®¢é˜…è¯¦æƒ…:\n\nKey: ${sub.sub_key}\nç‰ˆæœ¬: ${sub.version}\næ ‡é¢˜: ${sub.title}\næè¿°: ${sub.abstract || 'æ— '}\nçŠ¶æ€: ${getStatusText(sub.status)}`);
        }

        // åˆ é™¤è®¢é˜…
        async function deleteSubscription(subKey, version, type) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤è®¢é˜… ${subKey} ç‰ˆæœ¬ ${version} å—ï¼Ÿ`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/subscriptions/${subKey}/versions/${version}?type=${type}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                if (result.code === 'OK') {
                    showSuccess('åˆ é™¤æˆåŠŸï¼');
                    loadSubscriptions(currentPage);
                } else {
                    showError('åˆ é™¤å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('Delete subscription error:', error);
                showError('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // é‡ç½®ç­›é€‰
        function resetFilters() {
            document.getElementById('searchKey').value = '';
            document.getElementById('filterStatus').value = '';
            loadSubscriptions(1);
        }

        // å·¥å…·å‡½æ•°
        function getTypeText(type) {
            return type === 'A' ? 'åˆ†ææ•°æ®' : 'ä¸šåŠ¡æ•°æ®';
        }

        function getStatusText(status) {
            const map = { 'A': 'å¾…ç”Ÿæ•ˆ', 'B': 'ç”Ÿæ•ˆä¸­', 'C': 'ç”Ÿæ•ˆä¸­-å¼ºåˆ¶å…¼å®¹ä½ç‰ˆæœ¬', 'D': 'å·²å¤±æ•ˆ' };
            return map[status] || status;
        }

        function getStatusBadgeClass(status) {
            const map = { 'A': 'bg-warning', 'B': 'bg-success', 'C': 'bg-info', 'D': 'bg-secondary' };
            return map[status] || 'bg-secondary';
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleString('zh-CN');
        }

        function showSuccess(message) {
            alert('âœ… ' + message);
        }

        function showError(message) {
            alert('âŒ ' + message);
        }
    </script>
</body>

</html>