<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>{{.title}}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/responsive.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
    <style>
        .status-badge {
            font-size: 0.85em;
        }

        .action-buttons .btn {
            margin-right: 5px;
        }

        .code-editor {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .verification-param.is-invalid {
            border-color: #dc3545;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(.375em + .1875rem) center;
            background-size: calc(.75em + .375rem) calc(.75em + .375rem);
            padding-right: calc(1.5em + .75rem);
        }

        #verificationParamsSection {
            border-left: 3px solid #ffc107;
            padding-left: 1rem;
            margin-left: -1rem;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/admin">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor"
                    class="bi bi-graph-up d-inline-block align-text-top me-1" viewBox="0 0 16 16">
                    <path fill-rule="evenodd"
                        d="M0 0h1v15h15v1H0V0Zm14.817 3.113a.5.5 0 0 1 .07.704l-4.5 5.5a.5.5 0 0 1-.74.037L7.06 6.767l-3.656 5.027a.5.5 0 0 1-.808-.588l4-5.5a.5.5 0 0 1 .758-.06l2.609 2.61 4.15-5.073a.5.5 0 0 1 .704-.07Z" />
                </svg>
                BIè®¢é˜…ç®¡ç†
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <div class="navbar-nav ms-auto">
                    <a class="nav-link active" href="/admin/subscriptions">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                            class="bi bi-list-task me-1" viewBox="0 0 16 16">
                            <path fill-rule="evenodd"
                                d="M2 2.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5V3a.5.5 0 0 0-.5-.5H2zM3 3H2v1h1V3z" />
                            <path
                                d="M5 3.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zM5.5 7a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 4a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9z" />
                            <path fill-rule="evenodd"
                                d="M1.5 7a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5H2a.5.5 0 0 1-.5-.5V7zM2 7h1v1H2V7zm0 3.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5H2zm1 .5H2v1h1v-1z" />
                        </svg>
                        è®¢é˜…ç®¡ç†
                    </a>
                    <a class="nav-link" href="/admin/stats">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                            class="bi bi-bar-chart me-1" viewBox="0 0 16 16">
                            <path
                                d="M4 11H2v3h2v-3zm5-4H7v7h2V7zm5-5v12h-2V2h2zm-2-1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h2a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1h-2zM6 7a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v7a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V7zm-5 4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1v-3z" />
                        </svg>
                        ç»Ÿè®¡æŠ¥è¡¨
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4 has-mobile-toolbar">
        <div class="page-header mb-4">
            <h2>è®¢é˜…ç®¡ç†</h2>
        </div>

        <!-- ç§»åŠ¨ç«¯æœç´¢åˆ‡æ¢æŒ‰é’® -->
        <button class="btn btn-outline-primary mobile-search-toggle d-md-none" onclick="toggleMobileSearch()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search me-1"
                viewBox="0 0 16 16">
                <path
                    d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z" />
            </svg>
            æœç´¢å’Œç­›é€‰
        </button>

        <!-- æœç´¢å’Œç­›é€‰ -->
        <div class="card mb-3 search-panel-mobile">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3 col-12">
                        <input type="text" class="form-control" id="searchKey" placeholder="æœç´¢è®¢é˜…Key">
                    </div>
                    <div class="col-md-3 col-12">
                        <input type="text" class="form-control" id="searchTitle" placeholder="æœç´¢æ ‡é¢˜">
                    </div>
                    <div class="col-md-2 col-6">
                        <select class="form-select" id="filterStatus">
                            <option value="">å…¨éƒ¨çŠ¶æ€</option>
                            <option value="A">å¾…ç”Ÿæ•ˆ</option>
                            <option value="B">ç”Ÿæ•ˆä¸­</option>
                            <option value="C">ç”Ÿæ•ˆä¸­-å¼ºåˆ¶å…¼å®¹ä½ç‰ˆæœ¬</option>
                            <option value="D">å·²å¤±æ•ˆ</option>
                        </select>
                    </div>
                    <div class="col-md-4 col-6">
                        <button class="btn btn-primary me-2" onclick="loadSubscriptions()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                class="bi bi-search" viewBox="0 0 16 16">
                                <path
                                    d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z" />
                            </svg>
                            <span class="d-none d-md-inline ms-1">æœç´¢</span>
                        </button>
                        <button class="btn btn-secondary me-2" onclick="resetFilters()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
                                <path fill-rule="evenodd"
                                    d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z" />
                                <path
                                    d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z" />
                            </svg>
                            <span class="d-none d-md-inline ms-1">é‡ç½®</span>
                        </button>
                        <button class="btn btn-success d-none d-md-inline-block" data-bs-toggle="modal"
                            data-bs-target="#createModal">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                class="bi bi-plus-lg me-1" viewBox="0 0 16 16">
                                <path
                                    d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2Z" />
                            </svg>
                            åˆ›å»ºè®¢é˜…
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- è®¢é˜…åˆ—è¡¨ -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>è®¢é˜…Key</th>
                                <th>ç‰ˆæœ¬</th>
                                <th class="hide-mobile">æ ‡é¢˜</th>
                                <th class="hide-mobile">ç±»å‹</th>
                                <th>çŠ¶æ€</th>
                                <th class="hide-mobile">åˆ›å»ºäºº</th>
                                <th class="hide-mobile">åˆ›å»ºæ—¶é—´</th>
                                <th style="min-width: 120px;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="subscriptionsTable">
                            <tr>
                                <td colspan="8" class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">åŠ è½½ä¸­...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- åˆ†é¡µ -->
                <nav>
                    <ul class="pagination justify-content-center" id="pagination"></ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘è®¢é˜…æ¨¡æ€æ¡† -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ç¼–è¾‘è®¢é˜…</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <input type="hidden" id="edit_sub_key">
                        <input type="hidden" id="edit_version">
                        <input type="hidden" id="edit_type">

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">è®¢é˜…Key</label>
                                    <input type="text" class="form-control" id="edit_sub_key_display" disabled>
                                    <div class="form-text text-muted">è®¢é˜…Keyä¸å¯ä¿®æ”¹</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">ç‰ˆæœ¬å·</label>
                                    <input type="text" class="form-control" id="edit_version_display" disabled>
                                    <div class="form-text text-muted">ç‰ˆæœ¬å·ä¸å¯ä¿®æ”¹</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">ç±»å‹</label>
                                    <input type="text" class="form-control" id="edit_type_display" disabled>
                                    <div class="form-text text-muted">ç±»å‹ä¸å¯ä¿®æ”¹</div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">æ ‡é¢˜ <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="edit_title" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">æè¿°</label>
                            <textarea class="form-control" id="edit_abstract" rows="2"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">SQLå†…å®¹ <span class="text-danger">*</span></label>
                            <textarea class="form-control code-editor" id="edit_sql_content" rows="10" required
                                placeholder="SELECT house_id, count(distinct device_id) as number&#10;FROM uhomes_stat.stat_demand_log_events&#10;where ts_time between 'start_at_replace' and 'end_at_replace'&#10;and house_id in (house_id_replace)&#10;group by house_id"></textarea>
                            <div class="form-text text-danger fw-bold">
                                âš ï¸ é‡è¦ï¼šä½¿ç”¨ <code>xxx_replace</code> æ ¼å¼ä½œä¸ºå˜é‡å ä½ç¬¦ï¼ˆå¦‚ï¼šstart_at_replace, house_id_replaceï¼‰
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label mb-0">SQLå˜é‡è¯´æ˜</label>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-primary"
                                        onclick="extractEditVariablesFromSQL()">
                                        ğŸ” æå–å˜é‡
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" onclick="addEditVariable()">
                                        + æ·»åŠ å˜é‡
                                    </button>
                                </div>
                            </div>
                            <div class="alert alert-info mb-2 py-2">
                                <small>ä» SQL å†…å®¹ä¸­æå– <code>xxx_replace</code> æ ¼å¼çš„å˜é‡ï¼Œä¸ºæ¯ä¸ªå˜é‡æ·»åŠ è¯´æ˜</small>
                            </div>
                            <div id="editVariablesList" class="mb-2">
                                <div class="text-muted small">æš‚æ— å˜é‡ï¼Œç‚¹å‡»"æå–å˜é‡"æˆ–"æ·»åŠ å˜é‡"</div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">æ•°æ®æº</label>
                                    <input type="text" class="form-control" id="edit_db_source" placeholder="default">
                                    <div class="form-text">ç•™ç©ºä½¿ç”¨é»˜è®¤æ•°æ®æº</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">çŠ¶æ€</label>
                                    <input type="text" class="form-control" value="å¾…ç”Ÿæ•ˆ" disabled>
                                    <div class="form-text text-muted">åªæœ‰"å¾…ç”Ÿæ•ˆ"çŠ¶æ€çš„è®¢é˜…å¯ä»¥ç¼–è¾‘</div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="updateSubscription()">ä¿å­˜ä¿®æ”¹</button>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ›å»ºè®¢é˜…æ¨¡æ€æ¡† -->
    <div class="modal fade" id="createModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">åˆ›å»ºè®¢é˜…</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">è®¢é˜…Key <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="sub_key" required>
                                    <div class="form-text">å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œå»ºè®®ä½¿ç”¨ä¸‹åˆ’çº¿å‘½å</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">ç‰ˆæœ¬å· <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" name="version" min="1" value="1" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">ç±»å‹ <span class="text-danger">*</span></label>
                                    <select class="form-select" name="type" required>
                                        <option value="A" selected>åˆ†ææ•°æ®</option>
                                        <option value="B">è¥é”€æ¨é€</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">æ ‡é¢˜ <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="title" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">æè¿°</label>
                            <textarea class="form-control" name="abstract" rows="2"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">SQLå†…å®¹ <span class="text-danger">*</span></label>
                            <textarea class="form-control code-editor" name="sql_content" rows="10" required
                                placeholder="SELECT house_id, count(distinct device_id) as number&#10;FROM uhomes_stat.stat_demand_log_events&#10;where ts_time between 'start_at_replace' and 'end_at_replace'&#10;and house_id in (house_id_replace)&#10;group by house_id"></textarea>
                            <div class="form-text text-danger fw-bold">
                                âš ï¸ é‡è¦ï¼šä½¿ç”¨ <code>xxx_replace</code> æ ¼å¼ä½œä¸ºå˜é‡å ä½ç¬¦ï¼ˆå¦‚ï¼šstart_at_replace, house_id_replaceï¼‰
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label mb-0">SQLå˜é‡è¯´æ˜</label>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-primary" onclick="extractVariablesFromSQL()">
                                        ğŸ” æå–å˜é‡
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" onclick="addVariable()">
                                        + æ·»åŠ å˜é‡
                                    </button>
                                </div>
                            </div>
                            <div class="alert alert-info mb-2 py-2">
                                <small>ä» SQL å†…å®¹ä¸­æå– <code>xxx_replace</code> æ ¼å¼çš„å˜é‡ï¼Œä¸ºæ¯ä¸ªå˜é‡æ·»åŠ è¯´æ˜</small>
                            </div>
                            <div id="variablesList" class="mb-2">
                                <div class="text-muted small">æš‚æ— å˜é‡ï¼Œç‚¹å‡»"æå–å˜é‡"æˆ–"æ·»åŠ å˜é‡"</div>
                            </div>
                            <input type="hidden" name="sql_replace" id="sql_replace_hidden">
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">æ•°æ®æº</label>
                                    <input type="text" class="form-control" name="db_source" placeholder="default">
                                    <div class="form-text">ç•™ç©ºä½¿ç”¨é»˜è®¤æ•°æ®æº</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">çŠ¶æ€</label>
                                    <input type="text" class="form-control" value="å¾…ç”Ÿæ•ˆ" disabled>
                                    <div class="form-text text-muted">æ–°åˆ›å»ºçš„è®¢é˜…é»˜è®¤ä¸º"å¾…ç”Ÿæ•ˆ"çŠ¶æ€</div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="createSubscription()">åˆ›å»º</button>
                </div>
            </div>
        </div>
    </div>

    <!-- çŠ¶æ€å˜æ›´æ¨¡æ€æ¡† -->
    <div class="modal fade" id="statusChangeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">å˜æ›´è®¢é˜…çŠ¶æ€</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">è®¢é˜…ä¿¡æ¯</label>
                        <div id="statusChangeInfo" class="alert alert-info"></div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">å½“å‰çŠ¶æ€</label>
                        <div id="currentStatus" class="mb-2"></div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">ç›®æ ‡çŠ¶æ€ <span class="text-danger">*</span></label>
                        <select class="form-select" id="targetStatus">
                            <option value="">è¯·é€‰æ‹©ç›®æ ‡çŠ¶æ€</option>
                            <option value="A">å¾…ç”Ÿæ•ˆ</option>
                            <option value="B">ç”Ÿæ•ˆä¸­</option>
                            <option value="C">ç”Ÿæ•ˆä¸­-å¼ºåˆ¶å…¼å®¹ä½ç‰ˆæœ¬</option>
                            <option value="D">å·²å¤±æ•ˆ</option>
                        </select>
                        <div class="form-text text-warning" id="statusChangeWarning" style="display:none;"></div>
                    </div>

                    <div class="alert alert-warning" id="executionRequiredAlert" style="display:none;">
                        <strong>âš ï¸ æ³¨æ„ï¼š</strong>ä»"å¾…ç”Ÿæ•ˆ"æˆ–"å·²å¤±æ•ˆ"çŠ¶æ€å˜æ›´ä¸º"ç”Ÿæ•ˆä¸­"æˆ–"ç”Ÿæ•ˆä¸­-å¼ºåˆ¶å…¼å®¹ä½ç‰ˆæœ¬"æ—¶ï¼Œéœ€è¦å…ˆæ‰§è¡Œä¸€æ¬¡è®¢é˜…ä»¥éªŒè¯ SQL æ˜¯å¦æ­£å¸¸ã€‚
                    </div>

                    <!-- éªŒè¯å‚æ•°è¾“å…¥åŒºåŸŸ -->
                    <div id="verificationParamsSection" style="display:none;">
                        <div class="mb-3">
                            <label class="form-label fw-bold">éªŒè¯å‚æ•°</label>
                            <div class="alert alert-info py-2 mb-2">
                                <small>è¯·å¡«å†™ä»¥ä¸‹å‚æ•°ä»¥éªŒè¯ SQL æ˜¯å¦å¯ä»¥æ­£å¸¸æ‰§è¡Œ</small>
                            </div>
                            <div id="verificationParamsList" class="row g-3">
                                <!-- å‚æ•°è¾“å…¥æ¡†å°†åŠ¨æ€ç”Ÿæˆ -->
                            </div>
                        </div>
                    </div>

                    <div id="executionStatus" style="display:none;">
                        <div class="alert alert-success">
                            <strong>âœ… SQL éªŒè¯é€šè¿‡</strong>
                            <div class="small mt-1">æœ€åæ‰§è¡Œæ—¶é—´: <span id="lastExecutionTime"></span></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-warning" id="executeBeforeChangeBtn" style="display:none;"
                        onclick="executeBeforeStatusChange()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                            class="bi bi-play-fill me-1" viewBox="0 0 16 16">
                            <path
                                d="m11.596 8.697-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393z" />
                        </svg>
                        å…ˆæ‰§è¡ŒéªŒè¯
                    </button>
                    <button type="button" class="btn btn-primary" id="confirmStatusChangeBtn"
                        onclick="confirmStatusChange()">ç¡®è®¤å˜æ›´</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ‰§è¡Œè®¢é˜…æ¨¡æ€æ¡† -->
    <div class="modal fade" id="executeModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">æ‰§è¡Œè®¢é˜…</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">è®¢é˜…ä¿¡æ¯</label>
                        <div id="executeInfo" class="alert alert-info"></div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">æ‰§è¡Œå‚æ•°</label>
                        <div id="executeParamsList" class="mb-2">
                            <!-- å‚æ•°åˆ—è¡¨å°†åŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label fw-bold mb-0">SQLé¢„è§ˆ</label>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="copySqlPreview()"
                                title="å¤åˆ¶SQL">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor"
                                    class="bi bi-clipboard" viewBox="0 0 16 16">
                                    <path
                                        d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z" />
                                    <path
                                        d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z" />
                                </svg>
                                å¤åˆ¶
                            </button>
                        </div>
                        <pre class="bg-light p-3 rounded code-editor" id="sqlPreview"
                            style="max-height: 300px; overflow-y: auto;"></pre>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">è¶…æ—¶æ—¶é—´ (æ¯«ç§’)</label>
                        <input type="number" class="form-control" id="executeTimeout" value="30000">
                    </div>

                    <div id="executeResult" class="mt-3" style="display:none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label fw-bold mb-0">æ‰§è¡Œç»“æœ</label>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-secondary" onclick="copyExecuteResult()"
                                    title="å¤åˆ¶ç»“æœ">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor"
                                        class="bi bi-clipboard" viewBox="0 0 16 16">
                                        <path
                                            d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z" />
                                        <path
                                            d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z" />
                                    </svg>
                                    å¤åˆ¶
                                </button>
                                <button type="button" class="btn btn-outline-success" onclick="exportToExcel()"
                                    title="å¯¼å‡ºExcel" id="exportExcelBtn" style="display:none;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor"
                                        class="bi bi-file-earmark-excel" viewBox="0 0 16 16">
                                        <path
                                            d="M5.884 6.68a.5.5 0 1 0-.768.64L7.349 10l-2.233 2.68a.5.5 0 0 0 .768.64L8 10.781l2.116 2.54a.5.5 0 0 0 .768-.641L8.651 10l2.233-2.68a.5.5 0 0 0-.768-.64L8 9.219l-2.116-2.54z" />
                                        <path
                                            d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z" />
                                    </svg>
                                    å¯¼å‡ºExcel
                                </button>
                            </div>
                        </div>
                        <pre class="bg-light p-3 rounded" id="executeResultContent"
                            style="max-height: 400px; overflow-y: auto;"></pre>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                    <button type="button" class="btn btn-primary" onclick="doExecute()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                            class="bi bi-play-fill me-1" viewBox="0 0 16 16">
                            <path
                                d="m11.596 8.697-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393z" />
                        </svg>
                        æ‰§è¡Œ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- æŸ¥çœ‹è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div class="modal fade" id="detailsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">è®¢é˜…è¯¦æƒ…</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="detailsContent">
                        <!-- è¯¦æƒ…å†…å®¹å°†åŠ¨æ€å¡«å…… -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast é€šçŸ¥å®¹å™¨ -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
        <div id="successToast" class="toast align-items-center text-white bg-success border-0" role="alert"
            aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        class="bi bi-check-circle me-2" viewBox="0 0 16 16">
                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z" />
                        <path
                            d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.061L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05z" />
                    </svg>
                    <span id="successToastMessage">æ“ä½œæˆåŠŸ</span>
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                    aria-label="Close"></button>
            </div>
        </div>
        <div id="errorToast" class="toast align-items-center text-white bg-danger border-0" role="alert"
            aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        class="bi bi-exclamation-circle me-2" viewBox="0 0 16 16">
                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z" />
                        <path
                            d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 4.995z" />
                    </svg>
                    <span id="errorToastMessage">æ“ä½œå¤±è´¥</span>
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                    aria-label="Close"></button>
            </div>
        </div>
    </div>

    <!-- ç§»åŠ¨ç«¯åº•éƒ¨å·¥å…·æ  -->
    <div class="mobile-toolbar d-md-none">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createModal">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-plus-circle"
                viewBox="0 0 16 16">
                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z" />
                <path
                    d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z" />
            </svg>
            <span>åˆ›å»º</span>
        </button>
        <button class="btn btn-outline-primary" onclick="loadSubscriptions(currentPage)">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor"
                class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z" />
                <path
                    d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z" />
            </svg>
            <span>åˆ·æ–°</span>
        </button>
        <a href="/admin/stats" class="btn btn-outline-secondary">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-bar-chart"
                viewBox="0 0 16 16">
                <path
                    d="M4 11H2v3h2v-3zm5-4H7v7h2V7zm5-5v12h-2V2h2zm-2-1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h2a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1h-2zM6 7a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v7a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V7zm-5 4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1v-3z" />
            </svg>
            <span>ç»Ÿè®¡</span>
        </a>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="/static/js/common.js"></script>
    <script>
        const API_BASE = '/api';
        let currentPage = 1;
        let currentLimit = 20;
        let executeContext = {};
        let statusChangeContext = {};
        let sqlExecutionVerified = false;

        // å˜é‡ç®¡ç†
        let variables = [];
        let editVariables = [];

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function () {
            loadSubscriptions();

            // ç›‘å¬ SQL å†…å®¹å˜åŒ–ï¼Œè‡ªåŠ¨æå–å˜é‡
            const sqlContent = document.querySelector('textarea[name="sql_content"]');
            if (sqlContent) {
                sqlContent.addEventListener('blur', extractVariablesFromSQL);
            }
        });

        // ä» SQL ä¸­æå–å˜é‡
        function extractVariablesFromSQL() {
            const sqlContent = document.querySelector('textarea[name="sql_content"]').value;

            if (!sqlContent.trim()) {
                showError('è¯·å…ˆè¾“å…¥ SQL å†…å®¹');
                return;
            }

            const regex = /(\w+_replace)/g;
            const matches = sqlContent.match(regex);

            if (matches) {
                const uniqueVars = [...new Set(matches)];
                let newCount = 0;

                // åªæ·»åŠ æ–°å˜é‡
                uniqueVars.forEach(varName => {
                    if (!variables.find(v => v.name === varName)) {
                        variables.push({ name: varName, description: '' });
                        newCount++;
                    }
                });

                renderVariables();

                // if (newCount > 0) {
                //     showSuccess(`æˆåŠŸæå– ${newCount} ä¸ªæ–°å˜é‡ï¼Œè¯·ä¸ºæ¯ä¸ªå˜é‡æ·»åŠ è¯´æ˜`);
                // } else {
                //     showSuccess('æ‰€æœ‰å˜é‡å·²å­˜åœ¨');
                // }
            } else {
                showError('æœªæ‰¾åˆ° xxx_replace æ ¼å¼çš„å˜é‡');
            }
        }

        // æ·»åŠ å˜é‡
        function addVariable() {
            const varName = prompt('è¯·è¾“å…¥å˜é‡åï¼ˆæ ¼å¼ï¼šxxx_replaceï¼‰ï¼š');
            if (varName) {
                if (!varName.endsWith('_replace')) {
                    showError('å˜é‡åå¿…é¡»ä»¥ _replace ç»“å°¾');
                    return;
                }
                if (variables.find(v => v.name === varName)) {
                    showError('å˜é‡å·²å­˜åœ¨');
                    return;
                }
                variables.push({ name: varName, description: '' });
                renderVariables();
            }
        }

        // åˆ é™¤å˜é‡
        function removeVariable(index) {
            variables.splice(index, 1);
            renderVariables();
        }

        // æ¸²æŸ“å˜é‡åˆ—è¡¨
        function renderVariables() {
            const container = document.getElementById('variablesList');
            if (variables.length === 0) {
                container.innerHTML = '<div class="text-muted small">æš‚æ— å˜é‡ï¼Œç‚¹å‡»"æå–å˜é‡"æˆ–"æ·»åŠ å˜é‡"</div>';
                return;
            }

            container.innerHTML = variables.map((v, index) => `
                <div class="input-group mb-2">
                    <span class="input-group-text bg-light" style="min-width: 150px;">
                        <code class="text-primary">${v.name}</code>
                    </span>
                    <input type="text" 
                           class="form-control ${!v.description || !v.description.trim() ? 'border-danger' : ''}" 
                           placeholder="å˜é‡è¯´æ˜ï¼ˆå¿…å¡«ï¼Œå¦‚ï¼šå¼€å§‹æ—¶é—´ï¼‰" 
                           value="${v.description || ''}" 
                           required
                           onchange="variables[${index}].description = this.value; renderVariables()">
                    <button class="btn btn-outline-danger" type="button" onclick="removeVariable(${index})" title="åˆ é™¤å˜é‡">
                        âœ•
                    </button>
                </div>
            `).join('');

            // æ˜¾ç¤ºéªŒè¯æç¤º
            const emptyVars = variables.filter(v => !v.description || !v.description.trim());
            if (emptyVars.length > 0) {
                container.innerHTML += `
                    <div class="alert alert-warning mt-2 py-2" role="alert">
                        <small>âš ï¸ è¿˜æœ‰ ${emptyVars.length} ä¸ªå˜é‡æœªå¡«å†™è¯´æ˜</small>
                    </div>
                `;
            }
        }

        // åŠ è½½è®¢é˜…åˆ—è¡¨
        async function loadSubscriptions(page = 1) {
            currentPage = page;
            const offset = (page - 1) * currentLimit;

            // è·å–æœç´¢æ¡ä»¶
            const searchKey = document.getElementById('searchKey').value.trim();
            const searchTitle = document.getElementById('searchTitle').value.trim();
            const filterStatus = document.getElementById('filterStatus').value;

            // æ„å»ºæŸ¥è¯¢å‚æ•°
            let url = `${API_BASE}/subscriptions?limit=${currentLimit}&offset=${offset}`;
            if (searchKey) url += `&sub_key=${encodeURIComponent(searchKey)}`;
            if (searchTitle) url += `&title=${encodeURIComponent(searchTitle)}`;
            if (filterStatus) url += `&status=${filterStatus}`;

            try {
                const response = await fetch(url);
                const result = await response.json();

                if (result.code === 'OK') {
                    renderSubscriptions(result.data.items || []);
                    renderPagination(result.data.pagination);
                } else {
                    showError('è·å–è®¢é˜…åˆ—è¡¨å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('Load subscriptions error:', error);
                showError('è·å–è®¢é˜…åˆ—è¡¨å¤±è´¥: ' + error.message);
            }
        }

        // æ¸²æŸ“è®¢é˜…åˆ—è¡¨
        function renderSubscriptions(subscriptions) {
            const tbody = document.getElementById('subscriptionsTable');

            if (subscriptions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4">æš‚æ— æ•°æ®</td></tr>';
                return;
            }

            tbody.innerHTML = subscriptions.map(sub => `
                <tr>
                    <td><code class="text-break">${sub.sub_key}</code></td>
                    <td><span class="badge bg-secondary">v${sub.version}</span></td>
                    <td class="hide-mobile">${sub.title || '-'}</td>
                    <td class="hide-mobile">${getTypeText(sub.type)}</td>
                    <td><span class="badge ${getStatusBadgeClass(sub.status)}">${getStatusText(sub.status)}</span></td>
                    <td class="hide-mobile">${sub.creator_id || '-'}</td>
                    <td class="hide-mobile">${formatDateTime(sub.created_at)}</td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-outline-success" onclick='showExecuteModal(${JSON.stringify(sub).replace(/'/g, "&#39;")})' title="æ‰§è¡Œ">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-play-fill" viewBox="0 0 16 16">
                                <path d="m11.596 8.697-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393z"/>
                            </svg>
                            <span class="d-none d-lg-inline ms-1">æ‰§è¡Œ</span>
                        </button>
                        <button class="btn btn-sm btn-outline-primary" onclick='viewDetails(${JSON.stringify(sub).replace(/'/g, "&#39;")})' title="æŸ¥çœ‹">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-eye" viewBox="0 0 16 16">
                                <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/>
                                <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/>
                            </svg>
                            <span class="d-none d-lg-inline ms-1">æŸ¥çœ‹</span>
                        </button>
                        <button class="btn btn-sm btn-outline-warning" onclick='showStatusChangeModal(${JSON.stringify(sub).replace(/'/g, "&#39;")})' title="å˜æ›´çŠ¶æ€">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-arrow-repeat" viewBox="0 0 16 16">
                                <path d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41zm-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9z"/>
                                <path fill-rule="evenodd" d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.002 6.002 0 0 1 13.917 7H12.9A5.002 5.002 0 0 0 8 3zM3.1 9a5.002 5.002 0 0 0 8.757 2.182.5.5 0 1 1 .771.636A6.002 6.002 0 0 1 2.083 9H3.1z"/>
                            </svg>
                            <span class="d-none d-lg-inline ms-1">çŠ¶æ€</span>
                        </button>
                        ${sub.status === 'A' ? `
                        <button class="btn btn-sm btn-outline-info" onclick='showEditModal(${JSON.stringify(sub).replace(/'/g, "&#39;")})' title="ç¼–è¾‘">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-pencil" viewBox="0 0 16 16">
                                <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                            </svg>
                            <span class="d-none d-lg-inline ms-1">ç¼–è¾‘</span>
                        </button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }

        // åˆ‡æ¢ç§»åŠ¨ç«¯æœç´¢é¢æ¿
        function toggleMobileSearch() {
            const panel = document.querySelector('.search-panel-mobile');
            panel.classList.toggle('show');
        }

        // æ¸²æŸ“åˆ†é¡µ
        function renderPagination(pagination) {
            if (!pagination) return;

            const paginationEl = document.getElementById('pagination');
            const { current_page, total_pages } = pagination;

            let html = '';

            // ä¸Šä¸€é¡µ
            if (current_page > 1) {
                html += `<li class="page-item"><a class="page-link" href="#" onclick="loadSubscriptions(${current_page - 1}); return false;">ä¸Šä¸€é¡µ</a></li>`;
            }

            // é¡µç 
            for (let i = 1; i <= total_pages; i++) {
                if (i === 1 || i === total_pages || (i >= current_page - 2 && i <= current_page + 2)) {
                    const active = i === current_page ? 'active' : '';
                    html += `<li class="page-item ${active}"><a class="page-link" href="#" onclick="loadSubscriptions(${i}); return false;">${i}</a></li>`;
                } else if (i === current_page - 3 || i === current_page + 3) {
                    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }

            // ä¸‹ä¸€é¡µ
            if (current_page < total_pages) {
                html += `<li class="page-item"><a class="page-link" href="#" onclick="loadSubscriptions(${current_page + 1}); return false;">ä¸‹ä¸€é¡µ</a></li>`;
            }

            paginationEl.innerHTML = html;
        }

        // åˆ›å»ºè®¢é˜…
        async function createSubscription() {
            const form = document.getElementById('createForm');
            const formData = new FormData(form);

            // ä» SQL ä¸­æå–æ‰€æœ‰å˜é‡
            const sqlContent = formData.get('sql_content');
            const regex = /(\w+_replace)/g;
            const sqlMatches = sqlContent.match(regex);
            const sqlVariables = sqlMatches ? [...new Set(sqlMatches)] : [];

            // æ„å»º SQL å˜é‡å¯¹è±¡ï¼ˆåªåŒ…å«æœ‰è¯´æ˜çš„å˜é‡ï¼‰
            const sqlReplace = {};
            const variablesWithDesc = [];

            variables.forEach(v => {
                if (v.name && v.description && v.description.trim()) {
                    sqlReplace[v.name] = v.description.trim();
                    variablesWithDesc.push(v.name);
                }
            });

            // ä¸¥æ ¼æ ¡éªŒï¼šSQL ä¸­çš„å˜é‡å¿…é¡»éƒ½æœ‰è¯´æ˜
            if (sqlVariables.length > 0) {
                // æ£€æŸ¥æ˜¯å¦æœ‰å˜é‡æ²¡æœ‰è¯´æ˜
                const missingDesc = variables.filter(v => v.name && (!v.description || !v.description.trim()));
                if (missingDesc.length > 0) {
                    showError(`ä»¥ä¸‹å˜é‡ç¼ºå°‘è¯´æ˜ï¼š${missingDesc.map(v => v.name).join(', ')}`);
                    return;
                }

                // æ£€æŸ¥ SQL ä¸­çš„å˜é‡æ˜¯å¦éƒ½åœ¨å˜é‡åˆ—è¡¨ä¸­
                const missingVars = sqlVariables.filter(v => !variablesWithDesc.includes(v));
                if (missingVars.length > 0) {
                    showError(`SQL ä¸­çš„ä»¥ä¸‹å˜é‡æœªæ·»åŠ è¯´æ˜ï¼š${missingVars.join(', ')}\nè¯·ç‚¹å‡»"æå–å˜é‡"æŒ‰é’®`);
                    return;
                }

                // æ£€æŸ¥å˜é‡åˆ—è¡¨ä¸­æ˜¯å¦æœ‰å¤šä½™çš„å˜é‡ï¼ˆä¸åœ¨ SQL ä¸­ï¼‰
                const extraVars = variablesWithDesc.filter(v => !sqlVariables.includes(v));
                if (extraVars.length > 0) {
                    if (!confirm(`å˜é‡åˆ—è¡¨ä¸­æœ‰ä¸åœ¨ SQL ä¸­çš„å˜é‡ï¼š${extraVars.join(', ')}\næ˜¯å¦ç»§ç»­æäº¤ï¼Ÿ`)) {
                        return;
                    }
                }

                // æœ€ç»ˆéªŒè¯ï¼šç¡®ä¿è‡³å°‘æœ‰ä¸€ä¸ªå˜é‡æœ‰è¯´æ˜
                if (Object.keys(sqlReplace).length === 0) {
                    showError('è¯·ä¸º SQL ä¸­çš„å˜é‡æ·»åŠ è¯´æ˜');
                    return;
                }
            }

            // æ„å»ºè¯·æ±‚æ•°æ®
            const data = {
                type: formData.get('type'),
                sub_key: formData.get('sub_key'),
                version: parseInt(formData.get('version')),
                title: formData.get('title'),
                abstract: formData.get('abstract') || '',
                status: 'A', // å›ºå®šä¸ºå¾…ç”Ÿæ•ˆçŠ¶æ€
                extra_config: {
                    sql_content: formData.get('sql_content'),
                    sql_replace: sqlReplace,
                    db_source: formData.get('db_source') || 'default',
                    example: JSON.stringify(sqlReplace)
                }
            };

            try {
                const response = await fetch(`${API_BASE}/subscriptions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (result.code === 'OK') {
                    showSuccess('è®¢é˜…åˆ›å»ºæˆåŠŸï¼');
                    bootstrap.Modal.getInstance(document.getElementById('createModal')).hide();
                    form.reset();
                    variables = []; // æ¸…ç©ºå˜é‡åˆ—è¡¨
                    renderVariables();
                    loadSubscriptions(currentPage);
                } else {
                    showError('åˆ›å»ºå¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('Create subscription error:', error);
                showError('åˆ›å»ºå¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤ºæ‰§è¡Œæ¨¡æ€æ¡†
        function showExecuteModal(sub) {
            executeContext = sub;
            document.getElementById('executeInfo').innerHTML = `
                <strong>è®¢é˜…Key:</strong> ${sub.sub_key}<br>
                <strong>ç‰ˆæœ¬:</strong> v${sub.version}<br>
                <strong>æ ‡é¢˜:</strong> ${sub.title}
            `;

            // æ¸²æŸ“å‚æ•°åˆ—è¡¨
            renderExecuteParams(sub);

            // åˆå§‹åŒ–SQLé¢„è§ˆ
            updateSqlPreview(sub);

            // é‡ç½®æ‰§è¡Œç»“æœå’Œå¯¼å‡ºæŒ‰é’®çŠ¶æ€
            document.getElementById('executeResult').style.display = 'none';
            document.getElementById('exportExcelBtn').style.display = 'none';
            window.lastExecuteResult = null;

            new bootstrap.Modal(document.getElementById('executeModal')).show();
        }

        // æ¸²æŸ“æ‰§è¡Œå‚æ•°åˆ—è¡¨
        function renderExecuteParams(sub) {
            const container = document.getElementById('executeParamsList');
            const sqlReplace = sub.extra_config?.sql_replace || {};

            if (Object.keys(sqlReplace).length === 0) {
                container.innerHTML = '<div class="alert alert-warning">è¯¥è®¢é˜…æ²¡æœ‰å®šä¹‰å‚æ•°</div>';
                return;
            }

            let html = '<div class="row g-3">';
            Object.entries(sqlReplace).forEach(([key, description]) => {
                html += `
                    <div class="col-md-6 col-12">
                        <label class="form-label">
                            <code class="text-primary">${key}</code>
                            <small class="text-muted ms-2">${description}</small>
                        </label>
                        <input type="text" 
                               class="form-control execute-param" 
                               data-param="${key}"
                               placeholder="è¯·è¾“å…¥${description}"
                               onchange="updateSqlPreview(executeContext)">
                    </div>
                `;
            });
            html += '</div>';

            container.innerHTML = html;
        }

        // æ›´æ–°SQLé¢„è§ˆ
        function updateSqlPreview(sub) {
            const sqlContent = sub.extra_config?.sql_content || '';
            const sqlReplace = sub.extra_config?.sql_replace || {};

            let previewSql = sqlContent;

            // è·å–æ‰€æœ‰å‚æ•°è¾“å…¥æ¡†çš„å€¼
            document.querySelectorAll('.execute-param').forEach(input => {
                const paramName = input.dataset.param;
                const paramValue = input.value.trim();

                if (paramValue) {
                    // æ›¿æ¢SQLä¸­çš„å ä½ç¬¦ï¼ˆä¸å¸¦å¼•å·ï¼‰
                    const regex = new RegExp(paramName, 'g');
                    previewSql = previewSql.replace(regex, paramValue);
                } else {
                    // å¦‚æœæ²¡æœ‰è¾“å…¥å€¼ï¼Œä¿æŒå ä½ç¬¦ä½†é«˜äº®æ˜¾ç¤º
                    const regex = new RegExp(`(${paramName})`, 'g');
                    previewSql = previewSql.replace(regex, `<span style="background-color: #fff3cd; color: #856404; padding: 2px 4px; border-radius: 3px;">$1</span>`);
                }
            });

            // å¦‚æœæ²¡æœ‰è¾“å…¥æ¡†ï¼ˆé¦–æ¬¡åŠ è½½ï¼‰ï¼Œé«˜äº®æ‰€æœ‰å ä½ç¬¦
            if (document.querySelectorAll('.execute-param').length === 0) {
                Object.keys(sqlReplace).forEach(paramName => {
                    const regex = new RegExp(`(${paramName})`, 'g');
                    previewSql = previewSql.replace(regex, `<span style="background-color: #fff3cd; color: #856404; padding: 2px 4px; border-radius: 3px;">$1</span>`);
                });
            }

            document.getElementById('sqlPreview').innerHTML = previewSql || 'æ— SQLå†…å®¹';
        }

        // æ‰§è¡Œè®¢é˜…
        async function doExecute() {
            const timeout = parseInt(document.getElementById('executeTimeout').value);

            // ä»è¾“å…¥æ¡†æ”¶é›†å‚æ•°
            const params = {};
            let hasEmptyParam = false;

            document.querySelectorAll('.execute-param').forEach(input => {
                const paramName = input.dataset.param;
                const paramValue = input.value.trim();

                if (!paramValue) {
                    hasEmptyParam = true;
                    input.classList.add('is-invalid');
                } else {
                    input.classList.remove('is-invalid');
                    params[paramName] = paramValue;
                }
            });

            if (hasEmptyParam) {
                showError('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å‚æ•°');
                return;
            }

            try {
                const url = `${API_BASE}/subscriptions/${executeContext.sub_key}/versions/${executeContext.version}/execute?type=${executeContext.type}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ variables: params, timeout: timeout })
                });

                const result = await response.json();
                const resultEl = document.getElementById('executeResult');
                const contentEl = document.getElementById('executeResultContent');
                const exportBtn = document.getElementById('exportExcelBtn');

                resultEl.style.display = 'block';
                if (result.code === 'OK') {
                    // å­˜å‚¨æ‰§è¡Œç»“æœæ•°æ®ä¾›å¯¼å‡ºä½¿ç”¨
                    window.lastExecuteResult = result.data;

                    contentEl.textContent = JSON.stringify(result.data, null, 2);
                    contentEl.className = 'bg-light p-3 rounded';

                    // å¦‚æœç»“æœæ˜¯æ•°ç»„æ ¼å¼ï¼Œæ˜¾ç¤ºå¯¼å‡ºExcelæŒ‰é’®
                    if (Array.isArray(result.data) && result.data.length > 0) {
                        exportBtn.style.display = 'inline-block';
                    } else {
                        exportBtn.style.display = 'none';
                    }
                } else {
                    window.lastExecuteResult = null;
                    contentEl.textContent = `é”™è¯¯: ${result.message}`;
                    contentEl.className = 'bg-danger text-white p-3 rounded';
                    exportBtn.style.display = 'none';
                }
            } catch (error) {
                console.error('Execute subscription error:', error);
                showError('æ‰§è¡Œå¤±è´¥: ' + error.message);
                window.lastExecuteResult = null;
                document.getElementById('exportExcelBtn').style.display = 'none';
            }
        }

        // æ˜¾ç¤ºç¼–è¾‘æ¨¡æ€æ¡†
        function showEditModal(sub) {
            // å¡«å……åŸºæœ¬ä¿¡æ¯
            document.getElementById('edit_sub_key').value = sub.sub_key;
            document.getElementById('edit_version').value = sub.version;
            document.getElementById('edit_type').value = sub.type;
            document.getElementById('edit_sub_key_display').value = sub.sub_key;
            document.getElementById('edit_version_display').value = 'v' + sub.version;
            document.getElementById('edit_type_display').value = getTypeText(sub.type);
            document.getElementById('edit_title').value = sub.title || '';
            document.getElementById('edit_abstract').value = sub.abstract || '';
            document.getElementById('edit_sql_content').value = sub.extra_config?.sql_content || '';
            document.getElementById('edit_db_source').value = sub.extra_config?.db_source || 'default';

            // åŠ è½½ç°æœ‰å˜é‡
            const sqlReplace = sub.extra_config?.sql_replace || {};
            editVariables = Object.entries(sqlReplace).map(([name, description]) => ({
                name,
                description
            }));
            renderEditVariables();

            new bootstrap.Modal(document.getElementById('editModal')).show();
        }

        // ä»ç¼–è¾‘è¡¨å•çš„ SQL ä¸­æå–å˜é‡
        function extractEditVariablesFromSQL() {
            const sqlContent = document.getElementById('edit_sql_content').value;

            if (!sqlContent.trim()) {
                showError('è¯·å…ˆè¾“å…¥ SQL å†…å®¹');
                return;
            }

            const regex = /(\w+_replace)/g;
            const matches = sqlContent.match(regex);

            if (matches) {
                const uniqueVars = [...new Set(matches)];
                let newCount = 0;

                uniqueVars.forEach(varName => {
                    if (!editVariables.find(v => v.name === varName)) {
                        editVariables.push({ name: varName, description: '' });
                        newCount++;
                    }
                });

                renderEditVariables();
            } else {
                showError('æœªæ‰¾åˆ° xxx_replace æ ¼å¼çš„å˜é‡');
            }
        }

        // æ·»åŠ ç¼–è¾‘å˜é‡
        function addEditVariable() {
            const varName = prompt('è¯·è¾“å…¥å˜é‡åï¼ˆæ ¼å¼ï¼šxxx_replaceï¼‰ï¼š');
            if (varName) {
                if (!varName.endsWith('_replace')) {
                    showError('å˜é‡åå¿…é¡»ä»¥ _replace ç»“å°¾');
                    return;
                }
                if (editVariables.find(v => v.name === varName)) {
                    showError('å˜é‡å·²å­˜åœ¨');
                    return;
                }
                editVariables.push({ name: varName, description: '' });
                renderEditVariables();
            }
        }

        // åˆ é™¤ç¼–è¾‘å˜é‡
        function removeEditVariable(index) {
            editVariables.splice(index, 1);
            renderEditVariables();
        }

        // æ¸²æŸ“ç¼–è¾‘å˜é‡åˆ—è¡¨
        function renderEditVariables() {
            const container = document.getElementById('editVariablesList');
            if (editVariables.length === 0) {
                container.innerHTML = '<div class="text-muted small">æš‚æ— å˜é‡ï¼Œç‚¹å‡»"æå–å˜é‡"æˆ–"æ·»åŠ å˜é‡"</div>';
                return;
            }

            container.innerHTML = editVariables.map((v, index) => `
                <div class="input-group mb-2">
                    <span class="input-group-text bg-light" style="min-width: 150px;">
                        <code class="text-primary">${v.name}</code>
                    </span>
                    <input type="text" 
                           class="form-control ${!v.description || !v.description.trim() ? 'border-danger' : ''}" 
                           placeholder="å˜é‡è¯´æ˜ï¼ˆå¿…å¡«ï¼Œå¦‚ï¼šå¼€å§‹æ—¶é—´ï¼‰" 
                           value="${v.description || ''}" 
                           required
                           onchange="editVariables[${index}].description = this.value; renderEditVariables()">
                    <button class="btn btn-outline-danger" type="button" onclick="removeEditVariable(${index})" title="åˆ é™¤å˜é‡">
                        âœ•
                    </button>
                </div>
            `).join('');

            const emptyVars = editVariables.filter(v => !v.description || !v.description.trim());
            if (emptyVars.length > 0) {
                container.innerHTML += `
                    <div class="alert alert-warning mt-2 py-2" role="alert">
                        <small>âš ï¸ è¿˜æœ‰ ${emptyVars.length} ä¸ªå˜é‡æœªå¡«å†™è¯´æ˜</small>
                    </div>
                `;
            }
        }

        // æ›´æ–°è®¢é˜…
        async function updateSubscription() {
            const subKey = document.getElementById('edit_sub_key').value;
            const version = document.getElementById('edit_version').value;
            const type = document.getElementById('edit_type').value;
            const title = document.getElementById('edit_title').value.trim();
            const abstract = document.getElementById('edit_abstract').value.trim();
            const sqlContent = document.getElementById('edit_sql_content').value.trim();
            const dbSource = document.getElementById('edit_db_source').value.trim() || 'default';

            if (!title) {
                showError('è¯·è¾“å…¥æ ‡é¢˜');
                return;
            }

            if (!sqlContent) {
                showError('è¯·è¾“å…¥ SQL å†…å®¹');
                return;
            }

            // éªŒè¯å˜é‡
            const regex = /(\w+_replace)/g;
            const sqlMatches = sqlContent.match(regex);
            const sqlVariables = sqlMatches ? [...new Set(sqlMatches)] : [];

            const sqlReplace = {};
            const variablesWithDesc = [];

            editVariables.forEach(v => {
                if (v.name && v.description && v.description.trim()) {
                    sqlReplace[v.name] = v.description.trim();
                    variablesWithDesc.push(v.name);
                }
            });

            if (sqlVariables.length > 0) {
                const missingDesc = editVariables.filter(v => v.name && (!v.description || !v.description.trim()));
                if (missingDesc.length > 0) {
                    showError(`ä»¥ä¸‹å˜é‡ç¼ºå°‘è¯´æ˜ï¼š${missingDesc.map(v => v.name).join(', ')}`);
                    return;
                }

                const missingVars = sqlVariables.filter(v => !variablesWithDesc.includes(v));
                if (missingVars.length > 0) {
                    showError(`SQL ä¸­çš„ä»¥ä¸‹å˜é‡æœªæ·»åŠ è¯´æ˜ï¼š${missingVars.join(', ')}\nè¯·ç‚¹å‡»"æå–å˜é‡"æŒ‰é’®`);
                    return;
                }

                if (Object.keys(sqlReplace).length === 0) {
                    showError('è¯·ä¸º SQL ä¸­çš„å˜é‡æ·»åŠ è¯´æ˜');
                    return;
                }
            }

            const data = {
                title: title,
                abstract: abstract,
                extra_config: {
                    sql_content: sqlContent,
                    sql_replace: sqlReplace,
                    db_source: dbSource,
                    example: JSON.stringify(sqlReplace)
                }
            };

            try {
                const url = `${API_BASE}/subscriptions/${subKey}/versions/${version}?type=${type}`;
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (result.code === 'OK') {
                    showSuccess('è®¢é˜…æ›´æ–°æˆåŠŸï¼');
                    bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
                    editVariables = [];
                    loadSubscriptions(currentPage);
                } else {
                    showError('æ›´æ–°å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('Update subscription error:', error);
                showError('æ›´æ–°å¤±è´¥: ' + error.message);
            }
        }

        // æŸ¥çœ‹è¯¦æƒ…
        function viewDetails(sub) {
            const detailsContent = document.getElementById('detailsContent');
            detailsContent.innerHTML = `
                <div class="row">
                    <div class="col-sm-4"><strong>è®¢é˜…Key:</strong></div>
                    <div class="col-sm-8"><code>${sub.sub_key}</code></div>
                </div>
                <div class="row mt-2">
                    <div class="col-sm-4"><strong>ç‰ˆæœ¬:</strong></div>
                    <div class="col-sm-8"><span class="badge bg-secondary">v${sub.version}</span></div>
                </div>
                <div class="row mt-2">
                    <div class="col-sm-4"><strong>æ ‡é¢˜:</strong></div>
                    <div class="col-sm-8">${sub.title}</div>
                </div>
                <div class="row mt-2">
                    <div class="col-sm-4"><strong>ç±»å‹:</strong></div>
                    <div class="col-sm-8">${getTypeText(sub.type)}</div>
                </div>
                <div class="row mt-2">
                    <div class="col-sm-4"><strong>çŠ¶æ€:</strong></div>
                    <div class="col-sm-8"><span class="badge ${getStatusBadgeClass(sub.status)}">${getStatusText(sub.status)}</span></div>
                </div>
                <div class="row mt-2">
                    <div class="col-sm-4"><strong>æè¿°:</strong></div>
                    <div class="col-sm-8">${sub.abstract || 'æ— '}</div>
                </div>
                <div class="row mt-2">
                    <div class="col-sm-4"><strong>åˆ›å»ºäºº:</strong></div>
                    <div class="col-sm-8">${sub.creator_id || '-'}</div>
                </div>
                <div class="row mt-2">
                    <div class="col-sm-4"><strong>åˆ›å»ºæ—¶é—´:</strong></div>
                    <div class="col-sm-8">${formatDateTime(sub.created_at)}</div>
                </div>
                <div class="row mt-2">
                    <div class="col-sm-4"><strong>æ•°æ®æº:</strong></div>
                    <div class="col-sm-8">${sub.extra_config?.db_source || 'default'}</div>
                </div>
            `;

            new bootstrap.Modal(document.getElementById('detailsModal')).show();
        }

        // æ˜¾ç¤ºçŠ¶æ€å˜æ›´æ¨¡æ€æ¡†
        function showStatusChangeModal(sub) {
            statusChangeContext = sub;
            sqlExecutionVerified = false;

            document.getElementById('statusChangeInfo').innerHTML = `
                <strong>è®¢é˜…Key:</strong> ${sub.sub_key}<br>
                <strong>ç‰ˆæœ¬:</strong> v${sub.version}<br>
                <strong>æ ‡é¢˜:</strong> ${sub.title}
            `;

            document.getElementById('currentStatus').innerHTML = `
                <span class="badge ${getStatusBadgeClass(sub.status)} fs-6">${getStatusText(sub.status)}</span>
            `;

            // é‡ç½®é€‰æ‹©
            document.getElementById('targetStatus').value = '';
            document.getElementById('statusChangeWarning').style.display = 'none';
            document.getElementById('executionRequiredAlert').style.display = 'none';
            document.getElementById('executionStatus').style.display = 'none';
            document.getElementById('executeBeforeChangeBtn').style.display = 'none';
            document.getElementById('verificationParamsSection').style.display = 'none';
            document.getElementById('confirmStatusChangeBtn').disabled = false;

            // ç›‘å¬ç›®æ ‡çŠ¶æ€å˜åŒ–
            document.getElementById('targetStatus').onchange = function () {
                checkStatusChangeRequirement(sub.status, this.value);
            };

            new bootstrap.Modal(document.getElementById('statusChangeModal')).show();
        }

        // æ¸²æŸ“éªŒè¯å‚æ•°è¾“å…¥æ¡†
        function renderVerificationParams(sub) {
            const container = document.getElementById('verificationParamsList');
            const sqlReplace = sub.extra_config?.sql_replace || {};

            if (Object.keys(sqlReplace).length === 0) {
                container.innerHTML = '<div class="col-12"><div class="alert alert-warning">è¯¥è®¢é˜…æ²¡æœ‰å®šä¹‰å‚æ•°</div></div>';
                return;
            }

            let html = '';
            Object.entries(sqlReplace).forEach(([key, description]) => {
                html += `
                    <div class="col-md-6 col-12">
                        <label class="form-label">
                            <code class="text-primary">${key}</code>
                            <small class="text-muted ms-2">${description}</small>
                        </label>
                        <input type="text" 
                               class="form-control verification-param" 
                               data-param="${key}"
                               placeholder="è¯·è¾“å…¥${description}">
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // æ£€æŸ¥çŠ¶æ€å˜æ›´è¦æ±‚
        function checkStatusChangeRequirement(currentStatus, targetStatus) {
            const warningEl = document.getElementById('statusChangeWarning');
            const alertEl = document.getElementById('executionRequiredAlert');
            const executeBtnEl = document.getElementById('executeBeforeChangeBtn');
            const confirmBtnEl = document.getElementById('confirmStatusChangeBtn');
            const executionStatusEl = document.getElementById('executionStatus');
            const verificationParamsEl = document.getElementById('verificationParamsSection');

            // é‡ç½®
            warningEl.style.display = 'none';
            alertEl.style.display = 'none';
            executeBtnEl.style.display = 'none';
            executionStatusEl.style.display = 'none';
            verificationParamsEl.style.display = 'none';
            confirmBtnEl.disabled = false;

            if (!targetStatus) {
                return;
            }

            // ç›¸åŒçŠ¶æ€
            if (currentStatus === targetStatus) {
                warningEl.textContent = 'âš ï¸ ç›®æ ‡çŠ¶æ€ä¸å½“å‰çŠ¶æ€ç›¸åŒ';
                warningEl.style.display = 'block';
                confirmBtnEl.disabled = true;
                return;
            }

            // ä» A(å¾…ç”Ÿæ•ˆ) æˆ– D(å·²å¤±æ•ˆ) å˜æ›´ä¸º B(ç”Ÿæ•ˆä¸­) æˆ– C(ç”Ÿæ•ˆä¸­-å¼ºåˆ¶å…¼å®¹ä½ç‰ˆæœ¬)
            if ((currentStatus === 'A' || currentStatus === 'D') && (targetStatus === 'B' || targetStatus === 'C')) {
                alertEl.style.display = 'block';

                if (!sqlExecutionVerified) {
                    // æ˜¾ç¤ºå‚æ•°è¾“å…¥åŒºåŸŸ
                    verificationParamsEl.style.display = 'block';
                    renderVerificationParams(statusChangeContext);
                    executeBtnEl.style.display = 'inline-block';
                    confirmBtnEl.disabled = true;
                    warningEl.textContent = 'âš ï¸ è¯·å…ˆå¡«å†™å‚æ•°å¹¶æ‰§è¡ŒéªŒè¯';
                    warningEl.style.display = 'block';
                }
            }
        }

        // æ‰§è¡ŒéªŒè¯ï¼ˆçŠ¶æ€å˜æ›´å‰ï¼‰
        async function executeBeforeStatusChange() {
            const sub = statusChangeContext;
            const sqlReplace = sub.extra_config?.sql_replace || {};

            // æ£€æŸ¥æ˜¯å¦æœ‰å‚æ•°
            if (Object.keys(sqlReplace).length === 0) {
                showError('è¯¥è®¢é˜…æ²¡æœ‰å®šä¹‰å‚æ•°ï¼Œæ— æ³•æ‰§è¡ŒéªŒè¯');
                return;
            }

            // ä»è¾“å…¥æ¡†æ”¶é›†å‚æ•°
            const params = {};
            let hasEmptyParam = false;

            document.querySelectorAll('.verification-param').forEach(input => {
                const paramName = input.dataset.param;
                const paramValue = input.value.trim();

                if (!paramValue) {
                    hasEmptyParam = true;
                    input.classList.add('is-invalid');
                } else {
                    input.classList.remove('is-invalid');
                    params[paramName] = paramValue;
                }
            });

            if (hasEmptyParam) {
                showError('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å‚æ•°');
                return;
            }

            // ç¦ç”¨æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const executeBtn = document.getElementById('executeBeforeChangeBtn');
            const originalText = executeBtn.innerHTML;
            executeBtn.disabled = true;
            executeBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>éªŒè¯ä¸­...';

            try {
                const url = `${API_BASE}/subscriptions/${sub.sub_key}/versions/${sub.version}/execute?type=${sub.type}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ variables: params, timeout: 30000 })
                });

                const result = await response.json();

                if (result.code === 'OK') {
                    sqlExecutionVerified = true;
                    document.getElementById('executionStatus').style.display = 'block';
                    document.getElementById('lastExecutionTime').textContent = new Date().toLocaleString('zh-CN');
                    document.getElementById('confirmStatusChangeBtn').disabled = false;
                    document.getElementById('statusChangeWarning').style.display = 'none';
                    document.getElementById('verificationParamsSection').style.display = 'none';
                    executeBtn.style.display = 'none';
                    showSuccess('SQL éªŒè¯é€šè¿‡ï¼');
                } else {
                    showError('SQL æ‰§è¡Œå¤±è´¥: ' + result.message);
                    executeBtn.disabled = false;
                    executeBtn.innerHTML = originalText;
                }
            } catch (error) {
                console.error('Execute verification error:', error);
                showError('æ‰§è¡ŒéªŒè¯å¤±è´¥: ' + error.message);
                executeBtn.disabled = false;
                executeBtn.innerHTML = originalText;
            }
        }

        // ç¡®è®¤çŠ¶æ€å˜æ›´
        async function confirmStatusChange() {
            const targetStatus = document.getElementById('targetStatus').value;

            if (!targetStatus) {
                showError('è¯·é€‰æ‹©ç›®æ ‡çŠ¶æ€');
                return;
            }

            const sub = statusChangeContext;
            const currentStatus = sub.status;

            // å†æ¬¡æ£€æŸ¥æ˜¯å¦éœ€è¦éªŒè¯
            if ((currentStatus === 'A' || currentStatus === 'D') && (targetStatus === 'B' || targetStatus === 'C')) {
                if (!sqlExecutionVerified) {
                    showError('è¯·å…ˆæ‰§è¡ŒéªŒè¯ SQL');
                    return;
                }
            }

            if (!confirm(`ç¡®å®šè¦å°†çŠ¶æ€ä»"${getStatusText(currentStatus)}"å˜æ›´ä¸º"${getStatusText(targetStatus)}"å—ï¼Ÿ`)) {
                return;
            }

            try {
                const url = `${API_BASE}/subscriptions/${sub.sub_key}/versions/${sub.version}/status?type=${sub.type}`;
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: targetStatus })
                });

                const result = await response.json();

                if (result.code === 'OK') {
                    showSuccess('çŠ¶æ€å˜æ›´æˆåŠŸï¼');
                    bootstrap.Modal.getInstance(document.getElementById('statusChangeModal')).hide();
                    loadSubscriptions(currentPage);
                } else {
                    showError('çŠ¶æ€å˜æ›´å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('Status change error:', error);
                showError('çŠ¶æ€å˜æ›´å¤±è´¥: ' + error.message);
            }
        }

        // é‡ç½®ç­›é€‰
        function resetFilters() {
            document.getElementById('searchKey').value = '';
            document.getElementById('searchTitle').value = '';
            document.getElementById('filterStatus').value = '';
            loadSubscriptions(1);
        }

        // å·¥å…·å‡½æ•°
        function getTypeText(type) {
            return type === 'A' ? 'åˆ†ææ•°æ®' : 'ä¸šåŠ¡æ•°æ®';
        }

        function getStatusText(status) {
            const map = { 'A': 'å¾…ç”Ÿæ•ˆ', 'B': 'ç”Ÿæ•ˆä¸­', 'C': 'ç”Ÿæ•ˆä¸­-å¼ºåˆ¶å…¼å®¹ä½ç‰ˆæœ¬', 'D': 'å·²å¤±æ•ˆ' };
            return map[status] || status;
        }

        function getStatusBadgeClass(status) {
            const map = { 'A': 'bg-warning', 'B': 'bg-success', 'C': 'bg-info', 'D': 'bg-secondary' };
            return map[status] || 'bg-secondary';
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleString('zh-CN');
        }

        function showSuccess(message) {
            const toast = document.getElementById('successToast');
            const messageEl = document.getElementById('successToastMessage');
            messageEl.textContent = message;

            const bsToast = new bootstrap.Toast(toast, {
                autohide: true,
                delay: 5000 // 5ç§’åè‡ªåŠ¨æ¶ˆå¤±
            });
            bsToast.show();
        }

        function showError(message) {
            const toast = document.getElementById('errorToast');
            const messageEl = document.getElementById('errorToastMessage');
            messageEl.textContent = message;

            const bsToast = new bootstrap.Toast(toast, {
                autohide: true,
                delay: 5000 // 5ç§’åè‡ªåŠ¨æ¶ˆå¤±
            });
            bsToast.show();
        }

        // å¤åˆ¶SQLé¢„è§ˆå†…å®¹
        function copySqlPreview() {
            const sqlPreview = document.getElementById('sqlPreview');
            const textContent = sqlPreview.textContent || sqlPreview.innerText;

            if (!textContent || textContent.trim() === 'æ— SQLå†…å®¹') {
                showError('æ²¡æœ‰å¯å¤åˆ¶çš„SQLå†…å®¹');
                return;
            }

            // è·å–å¤åˆ¶æŒ‰é’®ï¼Œæ·»åŠ è§†è§‰åé¦ˆ
            const copyBtn = event.target.closest('button');
            const originalText = copyBtn.innerHTML;

            navigator.clipboard.writeText(textContent).then(() => {
                // æ˜¾ç¤ºæˆåŠŸåé¦ˆ
                copyBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-check" viewBox="0 0 16 16">
                        <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
                    </svg>
                    å·²å¤åˆ¶
                `;
                copyBtn.classList.add('btn-success');
                copyBtn.classList.remove('btn-outline-secondary');

                setTimeout(() => {
                    copyBtn.innerHTML = originalText;
                    copyBtn.classList.remove('btn-success');
                    copyBtn.classList.add('btn-outline-secondary');
                }, 2000);

                showSuccess('SQLå†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•
                const textArea = document.createElement('textarea');
                textArea.value = textContent;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    // æ˜¾ç¤ºæˆåŠŸåé¦ˆ
                    copyBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-check" viewBox="0 0 16 16">
                            <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
                        </svg>
                        å·²å¤åˆ¶
                    `;
                    copyBtn.classList.add('btn-success');
                    copyBtn.classList.remove('btn-outline-secondary');

                    setTimeout(() => {
                        copyBtn.innerHTML = originalText;
                        copyBtn.classList.remove('btn-success');
                        copyBtn.classList.add('btn-outline-secondary');
                    }, 2000);

                    showSuccess('SQLå†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                } catch (e) {
                    showError('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶');
                }
                document.body.removeChild(textArea);
            });
        }

        // å¤åˆ¶æ‰§è¡Œç»“æœå†…å®¹
        function copyExecuteResult() {
            const resultContent = document.getElementById('executeResultContent');
            const textContent = resultContent.textContent || resultContent.innerText;

            if (!textContent || textContent.trim() === '') {
                showError('æ²¡æœ‰å¯å¤åˆ¶çš„æ‰§è¡Œç»“æœ');
                return;
            }

            // è·å–å¤åˆ¶æŒ‰é’®ï¼Œæ·»åŠ è§†è§‰åé¦ˆ
            const copyBtn = event.target.closest('button');
            const originalText = copyBtn.innerHTML;

            navigator.clipboard.writeText(textContent).then(() => {
                // æ˜¾ç¤ºæˆåŠŸåé¦ˆ
                copyBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-check" viewBox="0 0 16 16">
                        <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
                    </svg>
                    å·²å¤åˆ¶
                `;
                copyBtn.classList.add('btn-success');
                copyBtn.classList.remove('btn-outline-secondary');

                setTimeout(() => {
                    copyBtn.innerHTML = originalText;
                    copyBtn.classList.remove('btn-success');
                    copyBtn.classList.add('btn-outline-secondary');
                }, 2000);

                showSuccess('æ‰§è¡Œç»“æœå·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•
                const textArea = document.createElement('textarea');
                textArea.value = textContent;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    // æ˜¾ç¤ºæˆåŠŸåé¦ˆ
                    copyBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-check" viewBox="0 0 16 16">
                            <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
                        </svg>
                        å·²å¤åˆ¶
                    `;
                    copyBtn.classList.add('btn-success');
                    copyBtn.classList.remove('btn-outline-secondary');

                    setTimeout(() => {
                        copyBtn.innerHTML = originalText;
                        copyBtn.classList.remove('btn-success');
                        copyBtn.classList.add('btn-outline-secondary');
                    }, 2000);

                    showSuccess('æ‰§è¡Œç»“æœå·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                } catch (e) {
                    showError('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶');
                }
                document.body.removeChild(textArea);
            });
        }

        // å¯¼å‡ºExcel
        function exportToExcel() {
            if (!window.lastExecuteResult || !Array.isArray(window.lastExecuteResult)) {
                showError('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®æˆ–æ•°æ®æ ¼å¼ä¸æ”¯æŒ');
                return;
            }

            try {
                const data = window.lastExecuteResult;

                if (data.length === 0) {
                    showError('æ•°æ®ä¸ºç©ºï¼Œæ— æ³•å¯¼å‡º');
                    return;
                }

                // åˆ›å»ºå·¥ä½œç°¿
                const wb = XLSX.utils.book_new();

                // åˆ›å»ºå·¥ä½œè¡¨
                const ws = XLSX.utils.json_to_sheet(data);

                // è®¾ç½®åˆ—å®½ï¼ˆå¯é€‰ï¼‰
                const colWidths = [];
                if (data.length > 0) {
                    Object.keys(data[0]).forEach(key => {
                        const maxLength = Math.max(
                            key.length,
                            ...data.map(row => String(row[key] || '').length)
                        );
                        colWidths.push({ wch: Math.min(maxLength + 2, 50) });
                    });
                    ws['!cols'] = colWidths;
                }

                // æ·»åŠ å·¥ä½œè¡¨åˆ°å·¥ä½œç°¿
                XLSX.utils.book_append_sheet(wb, ws, 'æŸ¥è¯¢ç»“æœ');

                // ç”Ÿæˆæ–‡ä»¶å
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');
                const filename = `${executeContext.sub_key}_v${executeContext.version}_${timestamp}.xlsx`;

                // å¯¼å‡ºæ–‡ä»¶
                XLSX.writeFile(wb, filename);

                showSuccess(`Excelæ–‡ä»¶å·²å¯¼å‡º: ${filename}`);

            } catch (error) {
                console.error('å¯¼å‡ºExcelå¤±è´¥:', error);
                showError('å¯¼å‡ºExcelå¤±è´¥: ' + error.message);
            }
        }
    </script>
</body>

</html>