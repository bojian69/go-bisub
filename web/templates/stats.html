<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>{{.title}}</title>
    <link href="/admin/static/css/vendor/bootstrap.min.css" rel="stylesheet">
    <link href="/admin/static/css/responsive.css" rel="stylesheet">
    <link href="/admin/static/css/style.css" rel="stylesheet">
    <style>
        .stat-card {
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .performance-good {
            color: #28a745;
        }

        .performance-warning {
            color: #ffc107;
        }

        .performance-bad {
            color: #dc3545;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/admin">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor"
                    class="bi bi-graph-up d-inline-block align-text-top me-1" viewBox="0 0 16 16">
                    <path fill-rule="evenodd"
                        d="M0 0h1v15h15v1H0V0Zm14.817 3.113a.5.5 0 0 1 .07.704l-4.5 5.5a.5.5 0 0 1-.74.037L7.06 6.767l-3.656 5.027a.5.5 0 0 1-.808-.588l4-5.5a.5.5 0 0 1 .758-.06l2.609 2.61 4.15-5.073a.5.5 0 0 1 .704-.07Z" />
                </svg>
                BI订阅管理
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <div class="navbar-nav ms-auto">
                    <a class="nav-link" href="/admin/subscriptions">订阅管理</a>
                    <a class="nav-link active" href="/admin/stats">统计报表</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <h2 class="mb-4">统计报表</h2>

        <!-- 查询条件 -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3 col-12">
                        <label class="form-label">开始时间</label>
                        <input type="datetime-local" class="form-control" id="startTime">
                    </div>
                    <div class="col-md-3 col-12">
                        <label class="form-label">结束时间</label>
                        <input type="datetime-local" class="form-control" id="endTime">
                    </div>
                    <div class="col-md-2 col-6">
                        <label class="form-label">订阅Key</label>
                        <input type="text" class="form-control" id="subKey" placeholder="可选">
                    </div>
                    <div class="col-md-2 col-6">
                        <label class="form-label">每页条数</label>
                        <select class="form-select" id="pageSize">
                            <option value="10">10</option>
                            <option value="20" selected>20</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                    <div class="col-md-2 col-12">
                        <label class="form-label d-none d-md-block">&nbsp;</label>
                        <button class="btn btn-primary w-100" onclick="loadStats()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                class="bi bi-search me-1" viewBox="0 0 16 16">
                                <path
                                    d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z" />
                            </svg>
                            查询
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 统计概览 -->
        <div class="row mb-4" id="statsOverview">
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <h6 class="text-muted">总调用次数</h6>
                        <h3 id="totalCalls">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <h6 class="text-muted">平均执行时间</h6>
                        <h3 id="avgTime">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <h6 class="text-muted">最快执行</h6>
                        <h3 id="minTime" class="performance-good">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <h6 class="text-muted">最慢执行</h6>
                        <h3 id="maxTime" class="performance-bad">-</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- 统计表格 -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>订阅Key</th>
                                <th>版本</th>
                                <th>调用次数</th>
                                <th class="hide-mobile">平均时间(ms)</th>
                                <th class="hide-mobile">最短时间(ms)</th>
                                <th>最长时间(ms)</th>
                                <th class="hide-mobile">创建人ID</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="statsTableBody">
                            <tr>
                                <td colspan="8" class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">加载中...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- 分页 -->
                <nav>
                    <ul class="pagination justify-content-center" id="pagination"></ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- SQL详情模态框 -->
    <div class="modal fade" id="sqlModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">SQL详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label"><strong>最快SQL</strong></label>
                        <pre class="bg-light p-3 rounded" id="fastestSql"></pre>
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><strong>最慢SQL</strong></label>
                        <pre class="bg-light p-3 rounded" id="slowestSql"></pre>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 移动端底部工具栏 -->
    <div class="mobile-toolbar d-md-none">
        <button class="btn btn-primary" onclick="loadStats()">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor"
                class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z" />
                <path
                    d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z" />
            </svg>
            <span>刷新</span>
        </button>
        <a href="/admin/subscriptions" class="btn btn-outline-primary">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-list-task"
                viewBox="0 0 16 16">
                <path fill-rule="evenodd"
                    d="M2 2.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5V3a.5.5 0 0 0-.5-.5H2zM3 3H2v1h1V3z" />
                <path
                    d="M5 3.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zM5.5 7a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 4a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9z" />
            </svg>
            <span>订阅</span>
        </a>
        <a href="/admin" class="btn btn-outline-secondary">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-house"
                viewBox="0 0 16 16">
                <path
                    d="M8.707 1.5a1 1 0 0 0-1.414 0L.646 8.146a.5.5 0 0 0 .708.708L2 8.207V13.5A1.5 1.5 0 0 0 3.5 15h9a1.5 1.5 0 0 0 1.5-1.5V8.207l.646.647a.5.5 0 0 0 .708-.708L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293L8.707 1.5zM13 7.207V13.5a.5.5 0 0 1-.5.5h-9a.5.5 0 0 1-.5-.5V7.207l5-5 5 5z" />
            </svg>
            <span>首页</span>
        </a>
    </div>

    <script src="/admin/static/js/vendor/bootstrap.bundle.min.js"></script>
    <script src="/admin/static/js/common.js"></script>
    <script>
        const API_BASE = '/api';
        let currentPage = 1;
        let currentStats = [];

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function () {
            initDateRange();
            loadStats();
        });

        // 初始化日期范围（默认最近7天）
        function initDateRange() {
            const now = new Date();
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);

            document.getElementById('endTime').value = formatDateTimeLocal(now);
            document.getElementById('startTime').value = formatDateTimeLocal(weekAgo);
        }

        // 加载统计数据
        async function loadStats(page = 1) {
            currentPage = page;
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            const subKey = document.getElementById('subKey').value;
            const limit = parseInt(document.getElementById('pageSize').value);
            const offset = (page - 1) * limit;

            if (!startTime || !endTime) {
                showError('请选择开始和结束时间');
                return;
            }

            try {
                let url = `${API_BASE}/subscriptions/stats?start_time=${encodeURIComponent(startTime)}&end_time=${encodeURIComponent(endTime)}&limit=${limit}&offset=${offset}`;
                if (subKey) {
                    url += `&sub_key=${encodeURIComponent(subKey)}`;
                }

                const response = await fetch(url);
                const result = await response.json();

                if (result.code === 'OK') {
                    currentStats = result.data || [];
                    renderStats(currentStats);
                    updateOverview(currentStats);
                } else {
                    showError('获取统计数据失败: ' + result.message);
                }
            } catch (error) {
                console.error('Load stats error:', error);
                showError('获取统计数据失败: ' + error.message);
            }
        }

        // 渲染统计表格
        function renderStats(stats) {
            const tbody = document.getElementById('statsTableBody');

            if (stats.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4">暂无数据</td></tr>';
                return;
            }

            tbody.innerHTML = stats.map(stat => `
                <tr>
                    <td><code class="text-break">${stat.subscription_key}</code></td>
                    <td><span class="badge bg-secondary">v${stat.version}</span></td>
                    <td><strong>${stat.call_count}</strong></td>
                    <td class="hide-mobile">${formatTime(stat.avg_execution_time)}</td>
                    <td class="hide-mobile performance-good">${formatTime(stat.min_execution_time)}</td>
                    <td class="${getPerformanceClass(stat.max_execution_time)}">${formatTime(stat.max_execution_time)}</td>
                    <td class="hide-mobile">${stat.creator_id || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-info" onclick='showSqlDetails(${JSON.stringify(stat).replace(/'/g, "&#39;")})'>
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-code-square" viewBox="0 0 16 16">
                                <path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/>
                                <path d="M6.854 4.646a.5.5 0 0 1 0 .708L4.207 8l2.647 2.646a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 0 1 .708 0zm2.292 0a.5.5 0 0 0 0 .708L11.793 8l-2.647 2.646a.5.5 0 0 0 .708.708l3-3a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708 0z"/>
                            </svg>
                            <span class="d-none d-lg-inline ms-1">SQL</span>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // 更新概览统计
        function updateOverview(stats) {
            if (stats.length === 0) {
                document.getElementById('totalCalls').textContent = '0';
                document.getElementById('avgTime').textContent = '-';
                document.getElementById('minTime').textContent = '-';
                document.getElementById('maxTime').textContent = '-';
                return;
            }

            const totalCalls = stats.reduce((sum, s) => sum + s.call_count, 0);
            const avgTimes = stats.map(s => s.avg_execution_time);
            const minTimes = stats.map(s => s.min_execution_time);
            const maxTimes = stats.map(s => s.max_execution_time);

            const overallAvg = avgTimes.reduce((sum, t) => sum + t, 0) / avgTimes.length;
            const overallMin = Math.min(...minTimes);
            const overallMax = Math.max(...maxTimes);

            document.getElementById('totalCalls').textContent = totalCalls.toLocaleString();
            document.getElementById('avgTime').textContent = formatTime(overallAvg);
            document.getElementById('minTime').textContent = formatTime(overallMin);
            document.getElementById('maxTime').textContent = formatTime(overallMax);
        }

        // 显示SQL详情
        function showSqlDetails(stat) {
            document.getElementById('fastestSql').textContent = stat.fastest_sql || '无数据';
            document.getElementById('slowestSql').textContent = stat.slowest_sql || '无数据';
            new bootstrap.Modal(document.getElementById('sqlModal')).show();
        }

        // 工具函数
        function formatTime(ms) {
            if (ms === null || ms === undefined) return '-';
            return Math.round(ms) + ' ms';
        }

        function getPerformanceClass(ms) {
            if (ms < 100) return 'performance-good';
            if (ms < 500) return 'performance-warning';
            return 'performance-bad';
        }

        function formatDateTimeLocal(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        function showError(message) {
            alert('❌ ' + message);
        }
    </script>
</body>

</html>